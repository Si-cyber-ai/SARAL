<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI Reporting Studio — SARAL</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
    rel="stylesheet" />
  <link rel="stylesheet" href="css/dashboard.css" />
  <style>
    /* ═══════════════════════════════════════════════════
       AI REPORTING STUDIO v2 — Interactive Evidence Processing
       ═══════════════════════════════════════════════════ */

    .studio-body {
      font-family: var(--font-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background: #f7f8fc;
      overflow-x: hidden;
    }

    /* ─── FLOATING TOP BAR ─── */
    .studio-topbar {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 32px;
      background: rgba(255, 255, 255, .85);
      backdrop-filter: blur(24px) saturate(180%);
      border-bottom: 1px solid rgba(0, 0, 0, .06);
    }

    .studio-topbar__logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-family: var(--font-display);
      font-size: 18px;
      font-weight: 700;
      color: #0f172a;
    }

    .studio-topbar__tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--blue-400);
      background: rgba(79, 140, 255, .1);
      border: 1px solid rgba(79, 140, 255, .15);
      padding: 5px 14px;
      border-radius: var(--radius-full);
    }

    .studio-topbar__back {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      font-weight: 500;
      color: #64748b;
      padding: 8px 18px;
      border-radius: var(--radius-full);
      border: 1px solid rgba(0, 0, 0, .1);
      transition: all var(--duration-fast);
    }

    .studio-topbar__back:hover {
      color: #0f172a;
      border-color: rgba(0, 0, 0, .2);
      background: rgba(0, 0, 0, .03);
    }

    /* ─── MAIN SPLIT LAYOUT ─── */
    .studio-main {
      display: flex;
      flex: 1;
      min-height: 100vh;
      padding-top: 58px;
    }

    /* ═══════ LEFT PANEL — EVIDENCE (60%) ═══════ */
    .studio-left {
      width: 60%;
      position: relative;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 48px 40px;
      background: linear-gradient(160deg, #eef2ff 0%, #e8edff 40%, #f0f4ff 100%);
      overflow: hidden;
    }

    .studio-left::before,
    .studio-left::after {
      content: '';
      position: absolute;
      border-radius: 50%;
      filter: blur(80px);
      pointer-events: none;
      opacity: .2;
    }

    .studio-left::before {
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, rgba(79, 140, 255, .25), transparent 70%);
      top: -80px;
      left: -100px;
      animation: ambientDrift 20s ease-in-out infinite alternate;
    }

    .studio-left::after {
      width: 350px;
      height: 350px;
      background: radial-gradient(circle, rgba(167, 139, 250, .2), transparent 70%);
      bottom: -50px;
      right: -60px;
      animation: ambientDrift 25s ease-in-out infinite alternate-reverse;
    }

    @keyframes ambientDrift {
      0% {
        transform: translate(0, 0) scale(1);
      }

      100% {
        transform: translate(40px, 30px) scale(1.15);
      }
    }

    .studio-left__grid {
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(rgba(79, 140, 255, .04) 1px, transparent 1px),
        linear-gradient(90deg, rgba(79, 140, 255, .04) 1px, transparent 1px);
      background-size: 40px 40px;
      pointer-events: none;
    }

    /* ─── UPLOAD GLASS PANEL ─── */
    .upload-glass {
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 560px;
      border-radius: 28px;
      background: rgba(255, 255, 255, .85);
      border: 1.5px solid rgba(0, 0, 0, .06);
      backdrop-filter: blur(20px);
      padding: 48px 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      cursor: pointer;
      transition: all 0.5s var(--ease-out);
      box-shadow: 0 4px 24px rgba(0, 0, 0, .04);
    }

    .upload-glass:hover {
      background: #fff;
      border-color: rgba(79, 140, 255, .25);
      box-shadow: 0 8px 40px rgba(79, 140, 255, .1);
    }

    .upload-glass__border {
      position: absolute;
      inset: -2px;
      border-radius: 30px;
      border: 2.5px dashed rgba(79, 140, 255, .25);
      pointer-events: none;
      animation: borderRotate 30s linear infinite;
    }

    @keyframes borderRotate {
      0% {
        border-color: rgba(79, 140, 255, .25);
      }

      33% {
        border-color: rgba(167, 139, 250, .25);
      }

      66% {
        border-color: rgba(52, 211, 153, .2);
      }

      100% {
        border-color: rgba(79, 140, 255, .25);
      }
    }

    .upload-glass__icon {
      width: 88px;
      height: 88px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, rgba(79, 140, 255, .15), rgba(167, 139, 250, .15));
      border: 1.5px solid rgba(79, 140, 255, .2);
      margin-bottom: 28px;
      position: relative;
      color: var(--blue-400);
    }

    .upload-glass__icon::after {
      content: '';
      position: absolute;
      inset: -12px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(79, 140, 255, .15), transparent 70%);
      animation: iconGlow 3s ease-in-out infinite alternate;
    }

    @keyframes iconGlow {
      0% {
        opacity: .5;
        transform: scale(.95);
      }

      100% {
        opacity: 1;
        transform: scale(1.1);
      }
    }

    .upload-glass__title {
      font-family: var(--font-display);
      font-size: 26px;
      font-weight: 700;
      color: #0f172a;
      letter-spacing: -0.02em;
      margin-bottom: 12px;
    }

    .upload-glass__desc {
      font-size: 15px;
      color: #64748b;
      line-height: 1.7;
      max-width: 380px;
      margin-bottom: 32px;
    }

    .upload-glass__desc strong {
      color: #334155;
      font-weight: 500;
    }

    .upload-glass__formats {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .upload-glass__format {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #64748b;
      background: rgba(79, 140, 255, .06);
      border: 1px solid rgba(79, 140, 255, .1);
      padding: 5px 12px;
      border-radius: var(--radius-full);
    }

    .upload-glass.is-dragover {
      border-color: rgba(79, 140, 255, .5);
      background: rgba(79, 140, 255, .08);
      box-shadow: 0 0 80px rgba(79, 140, 255, .15);
      transform: scale(1.01);
    }

    .upload-glass.is-hidden {
      display: none;
    }

    /* ═══════ EVIDENCE PREVIEW — CARD STACK + CV OVERLAY ═══════ */
    .evidence-stage {
      display: none;
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 580px;
      flex-direction: column;
      align-items: center;
      gap: 24px;
      animation: stageAppear .6s var(--ease-out) both;
    }

    @keyframes stageAppear {
      from {
        opacity: 0;
        transform: scale(.92) translateY(20px);
      }

      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .evidence-stage.is-active {
      display: flex;
    }

    /* Stacked card container */
    .card-stack {
      position: relative;
      width: 100%;
      height: 400px;
      perspective: 1200px;
      overflow: hidden;
      border-radius: 24px;
    }

    .card-stack__item {
      position: absolute;
      inset: 0;
      border-radius: 24px;
      overflow: hidden;
      border: 1.5px solid rgba(0, 0, 0, .08);
      box-shadow: 0 20px 60px rgba(0, 0, 0, .1), 0 0 30px rgba(79, 140, 255, .04);
      transition: all 0.6s cubic-bezier(0.16, 1, 0.3, 1);
      background: #fff;
    }

    .card-stack__item:nth-child(1) {
      z-index: 3;
      transform: translateY(0) scale(1);
    }

    .card-stack__item:nth-child(2) {
      z-index: 2;
      transform: translateY(14px) scale(.96);
      opacity: .6;
      filter: blur(1px);
    }

    .card-stack__item:nth-child(3) {
      z-index: 1;
      transform: translateY(28px) scale(.92);
      opacity: .3;
      filter: blur(2px);
    }

    .card-stack__item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .card-stack {
      animation: stackFloat 5s ease-in-out infinite;
    }

    @keyframes stackFloat {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-8px);
      }
    }

    /* ═══ AI VISION SCANNING HUD ═══ */
    .processing-overlay {
      position: absolute;
      inset: 0;
      z-index: 12;
      border-radius: 24px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 16px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .5s ease;
    }

    .processing-overlay.is-active {
      opacity: 1;
      pointer-events: auto;
    }

    /* 1. DARK BLUR BACKDROP */
    .hud-backdrop {
      position: absolute;
      inset: 0;
      border-radius: 24px;
      backdrop-filter: blur(10px);
      background: rgba(0, 0, 0, .35);
      transition: backdrop-filter 1s ease, background 1s ease;
    }

    .processing-overlay.is-done .hud-backdrop {
      backdrop-filter: blur(0);
      background: transparent;
    }

    /* 2. SCANNING LINE — neon cyan, top→bottom */
    .hud-scanline {
      position: absolute;
      left: 0;
      right: 0;
      height: 2px;
      z-index: 4;
      background: linear-gradient(90deg, transparent 0%, rgba(0, 255, 255, .15) 15%, #00fffe 45%, #00e5ff 55%, rgba(0, 255, 255, .15) 85%, transparent 100%);
      box-shadow:
        0 0 8px 2px rgba(0, 255, 255, .6),
        0 0 30px 6px rgba(0, 255, 255, .25),
        0 0 80px 12px rgba(0, 255, 255, .08);
      animation: hudScanMove 2s linear infinite;
    }

    /* Trailing glow gradient behind the scanline */
    .hud-scanline::after {
      content: '';
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      height: 60px;
      background: linear-gradient(to bottom, rgba(0, 255, 255, .12) 0%, transparent 100%);
      pointer-events: none;
    }

    @keyframes hudScanMove {
      0% {
        top: -2px;
        opacity: 0;
      }

      3% {
        opacity: 1;
      }

      97% {
        opacity: 1;
      }

      100% {
        top: 100%;
        opacity: 0;
      }
    }

    /* 3. GRID OVERLAY */
    .hud-grid {
      position: absolute;
      inset: 0;
      z-index: 2;
      border-radius: 24px;
      opacity: 0;
      transition: opacity .5s ease .3s;
      background-image:
        linear-gradient(rgba(0, 255, 255, .06) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 255, 255, .06) 1px, transparent 1px);
      background-size: 32px 32px;
      pointer-events: none;
    }

    .processing-overlay.is-active .hud-grid {
      opacity: 1;
    }

    /* 4. DETECTION BOX */
    .hud-detect-box {
      position: absolute;
      z-index: 5;
      top: 28%;
      left: 18%;
      width: 64%;
      height: 40%;
      border: 1.5px solid rgba(0, 255, 255, .7);
      border-radius: 6px;
      opacity: 0;
      transition: opacity .4s ease;
      animation: hudBoxPulse 1.2s ease-in-out infinite;
      box-shadow: 0 0 12px 2px rgba(0, 255, 255, .2), inset 0 0 12px 2px rgba(0, 255, 255, .05);
    }

    .hud-detect-box.is-visible {
      opacity: 1;
    }

    /* Corner brackets */
    .hud-detect-box::before,
    .hud-detect-box::after {
      content: '';
      position: absolute;
      width: 18px;
      height: 18px;
      border-color: #00fffe;
      border-style: solid;
    }

    .hud-detect-box::before {
      top: -1px;
      left: -1px;
      border-width: 2px 0 0 2px;
      border-radius: 4px 0 0 0;
    }

    .hud-detect-box::after {
      bottom: -1px;
      right: -1px;
      border-width: 0 2px 2px 0;
      border-radius: 0 0 4px 0;
    }

    .hud-corner-tr,
    .hud-corner-bl {
      position: absolute;
      width: 18px;
      height: 18px;
      border-color: #00fffe;
      border-style: solid;
    }

    .hud-corner-tr {
      top: -1px;
      right: -1px;
      border-width: 2px 2px 0 0;
      border-radius: 0 4px 0 0;
    }

    .hud-corner-bl {
      bottom: -1px;
      left: -1px;
      border-width: 0 0 2px 2px;
      border-radius: 0 0 0 4px;
    }

    @keyframes hudBoxPulse {

      0%,
      100% {
        transform: scale(1);
        box-shadow: 0 0 12px 2px rgba(0, 255, 255, .2), inset 0 0 12px 2px rgba(0, 255, 255, .05);
      }

      50% {
        transform: scale(1.03);
        box-shadow: 0 0 24px 6px rgba(0, 255, 255, .3), inset 0 0 20px 4px rgba(0, 255, 255, .08);
      }
    }

    /* Detection label tag */
    .hud-detect-label {
      position: absolute;
      top: -22px;
      left: 0;
      background: rgba(0, 255, 255, .15);
      backdrop-filter: blur(6px);
      border: 1px solid rgba(0, 255, 255, .4);
      padding: 2px 8px;
      font-family: var(--font-display);
      font-size: 10px;
      font-weight: 600;
      color: #00fffe;
      letter-spacing: .6px;
      border-radius: 4px;
      text-transform: uppercase;
      white-space: nowrap;
    }

    /* 5. AI LOADER RING */
    .hud-ring {
      position: relative;
      z-index: 6;
      width: 60px;
      height: 60px;
    }

    .hud-ring svg {
      width: 60px;
      height: 60px;
      animation: hudRingSpin 1.5s linear infinite;
      filter: drop-shadow(0 0 6px rgba(0, 255, 255, .4));
    }

    .hud-ring circle {
      fill: none;
      stroke-width: 2;
      stroke-linecap: round;
    }

    .hud-ring-track {
      stroke: rgba(0, 255, 255, .1);
    }

    .hud-ring-progress {
      stroke: url(#hudRingGrad);
      stroke-dasharray: 160;
      stroke-dashoffset: 50;
      animation: hudRingDash 2s ease-in-out infinite alternate;
    }

    @keyframes hudRingSpin {
      to {
        transform: rotate(360deg);
      }
    }

    @keyframes hudRingDash {
      0% {
        stroke-dashoffset: 50;
      }

      100% {
        stroke-dashoffset: 120;
      }
    }

    /* Pulse glow behind ring */
    .hud-ring::after {
      content: '';
      position: absolute;
      inset: -8px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(0, 255, 255, .12) 0%, transparent 70%);
      animation: hudRingPulse 1.5s ease-in-out infinite;
    }

    @keyframes hudRingPulse {

      0%,
      100% {
        transform: scale(.9);
        opacity: .4;
      }

      50% {
        transform: scale(1.1);
        opacity: .8;
      }
    }

    /* 6. DYNAMIC STATUS TEXT */
    .hud-status {
      position: relative;
      z-index: 6;
      font-family: var(--font-display);
      font-size: 13px;
      font-weight: 600;
      color: #00fffe;
      letter-spacing: .06em;
      text-shadow: 0 0 12px rgba(0, 255, 255, .4), 0 2px 8px rgba(0, 0, 0, .4);
      min-height: 20px;
      text-align: center;
    }

    .hud-status span {
      display: inline-block;
      animation: hudTextFade 1s ease;
    }

    @keyframes hudTextFade {
      0% {
        opacity: 0;
        transform: translateY(6px);
      }

      20% {
        opacity: 1;
        transform: translateY(0);
      }

      80% {
        opacity: 1;
      }

      100% {
        opacity: 1;
      }
    }

    /* 7. PARTICLE CANVAS */
    .hud-particles {
      position: absolute;
      inset: 0;
      z-index: 3;
      border-radius: 24px;
      pointer-events: none;
    }

    /* HUD CROSSHAIR LINES (subtle) */
    .hud-crosshair {
      position: absolute;
      inset: 0;
      z-index: 3;
      pointer-events: none;
      opacity: 0;
      transition: opacity .6s ease .5s;
    }

    .processing-overlay.is-active .hud-crosshair {
      opacity: 1;
    }

    .hud-crosshair::before,
    .hud-crosshair::after {
      content: '';
      position: absolute;
      background: rgba(0, 255, 255, .08);
    }

    .hud-crosshair::before {
      top: 0;
      bottom: 0;
      left: 50%;
      width: 1px;
    }

    .hud-crosshair::after {
      left: 0;
      right: 0;
      top: 50%;
      height: 1px;
    }

    /* TIMESTAMP HUD element */
    .hud-timestamp {
      position: absolute;
      bottom: 12px;
      right: 14px;
      z-index: 6;
      font-family: var(--font-display);
      font-size: 10px;
      color: rgba(0, 255, 255, .5);
      letter-spacing: .8px;
      opacity: 0;
      transition: opacity .4s ease .6s;
    }

    .processing-overlay.is-active .hud-timestamp {
      opacity: 1;
    }

    .hud-cam-id {
      position: absolute;
      top: 12px;
      left: 14px;
      z-index: 6;
      font-family: var(--font-display);
      font-size: 10px;
      color: rgba(0, 255, 255, .45);
      letter-spacing: .6px;
      opacity: 0;
      transition: opacity .4s ease .4s;
    }

    .processing-overlay.is-active .hud-cam-id {
      opacity: 1;
    }

    /* Blinking REC dot */
    .hud-rec-dot {
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #ef4444;
      margin-right: 5px;
      vertical-align: middle;
      animation: hudRecBlink 1s step-end infinite;
    }

    @keyframes hudRecBlink {
      50% {
        opacity: 0;
      }
    }

    /* 8. COMPLETION STATE */
    .processing-overlay.is-done .hud-scanline,
    .processing-overlay.is-done .hud-grid,
    .processing-overlay.is-done .hud-crosshair,
    .processing-overlay.is-done .hud-detect-box,
    .processing-overlay.is-done .hud-ring,
    .processing-overlay.is-done .hud-status,
    .processing-overlay.is-done .hud-particles,
    .processing-overlay.is-done .hud-timestamp,
    .processing-overlay.is-done .hud-cam-id {
      opacity: 0 !important;
      transition: opacity .6s ease;
      pointer-events: none;
    }

    /* Detection box locks into final position on done */
    .processing-overlay.is-done .hud-detect-box {
      animation: none;
      transform: scale(1);
    }

    /* ─── DELETE / REMOVE BUTTON ─── */
    .evidence-stage__delete {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 25;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(239, 68, 68, .85);
      backdrop-filter: blur(8px);
      border: 1.5px solid rgba(255, 255, 255, .2);
      color: white;
      cursor: pointer;
      transition: all .25s var(--ease-out);
      box-shadow: 0 4px 16px rgba(239, 68, 68, .3);
    }

    .evidence-stage__delete:hover {
      background: rgba(239, 68, 68, 1);
      transform: scale(1.1);
      box-shadow: 0 6px 24px rgba(239, 68, 68, .45);
    }

    .evidence-stage__delete:active {
      transform: scale(.95);
    }

    /* ─── MANUAL PLATE INPUT ─── */
    .plate-entry {
      width: 100%;
      max-width: 420px;
      padding: 20px 24px;
      border-radius: 20px;
      background: rgba(255, 255, 255, .9);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(0, 0, 0, .06);
      box-shadow: 0 2px 12px rgba(0, 0, 0, .04);
      display: flex;
      flex-direction: column;
      gap: 10px;
      animation: fadeSlideUp .5s .3s var(--ease-out) both;
    }

    @keyframes fadeSlideUp {
      from {
        opacity: 0;
        transform: translateY(12px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .plate-entry__label {
      font-size: 13px;
      font-weight: 500;
      color: #64748b;
    }

    .plate-entry__label strong {
      color: #334155;
    }

    .plate-entry__row {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .plate-entry__input {
      flex: 1;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1.5px solid rgba(0, 0, 0, .1);
      background: #fff;
      font-family: 'Space Grotesk', monospace;
      font-size: 16px;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #0f172a;
      outline: none;
      transition: all .3s var(--ease-out);
    }

    .plate-entry__input::placeholder {
      color: #cbd5e1;
      font-weight: 400;
      letter-spacing: 0.06em;
    }

    .plate-entry__input:focus {
      border-color: rgba(79, 140, 255, .45);
      box-shadow: 0 0 0 4px rgba(79, 140, 255, .08);
    }

    .plate-entry__input.is-invalid {
      border-color: rgba(239, 68, 68, .5);
      box-shadow: 0 0 0 4px rgba(239, 68, 68, .08);
    }

    .plate-entry__hint {
      font-size: 11px;
      color: #94a3b8;
    }

    /* ─── PLATE VERIFICATION BADGE ─── */
    .plate-verify-badge {
      display: none;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: var(--radius-full);
      font-size: 13px;
      font-weight: 600;
      animation: badgePop .5s var(--ease-spring) both;
    }

    @keyframes badgePop {
      from {
        opacity: 0;
        transform: scale(.85);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .plate-verify-badge.is-visible {
      display: inline-flex;
    }

    .plate-verify-badge--match {
      background: rgba(16, 185, 129, .1);
      border: 1.5px solid rgba(16, 185, 129, .3);
      color: #059669;
    }

    .plate-verify-badge--mismatch {
      background: rgba(245, 158, 11, .1);
      border: 1.5px solid rgba(245, 158, 11, .3);
      color: #d97706;
    }

    .plate-verify-badge__pulse {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .plate-verify-badge--match .plate-verify-badge__pulse {
      background: #10b981;
      animation: successPulse 2s ease-in-out infinite;
    }

    .plate-verify-badge--mismatch .plate-verify-badge__pulse {
      background: #f59e0b;
    }

    @keyframes successPulse {

      0%,
      100% {
        box-shadow: 0 0 0 0 rgba(16, 185, 129, .4);
      }

      50% {
        box-shadow: 0 0 0 6px rgba(16, 185, 129, 0);
      }
    }

    /* ─── AI RESULTS DISPLAY ─── */
    .ai-results {
      width: 100%;
      max-width: 420px;
      display: none;
      flex-direction: column;
      gap: 10px;
      animation: resultsFadeIn .6s var(--ease-out) both;
    }

    .ai-results.is-visible {
      display: flex;
    }

    @keyframes resultsFadeIn {
      from {
        opacity: 0;
        transform: translateY(16px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .ai-results__card {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 16px 20px;
      border-radius: 16px;
      background: rgba(255, 255, 255, .92);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(0, 0, 0, .06);
      box-shadow: 0 2px 12px rgba(0, 0, 0, .04);
      transition: all .3s var(--ease-out);
      animation: resultCardIn .5s var(--ease-out) both;
    }

    .ai-results__card:nth-child(1) {
      animation-delay: .1s;
    }

    .ai-results__card:nth-child(2) {
      animation-delay: .2s;
    }

    .ai-results__card:nth-child(3) {
      animation-delay: .3s;
    }

    .ai-results__card:nth-child(4) {
      animation-delay: .4s;
    }

    @keyframes resultCardIn {
      from {
        opacity: 0;
        transform: translateX(-12px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .ai-results__card:hover {
      border-color: rgba(79, 140, 255, .2);
      box-shadow: 0 4px 20px rgba(79, 140, 255, .08);
      transform: translateX(4px);
    }

    .ai-results__icon {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .ai-results__icon--plate {
      background: linear-gradient(135deg, rgba(251, 191, 36, .15), rgba(245, 158, 11, .15));
      color: #f59e0b;
    }

    .ai-results__icon--violation {
      background: linear-gradient(135deg, rgba(239, 68, 68, .12), rgba(244, 63, 94, .12));
      color: #ef4444;
    }

    .ai-results__icon--confidence {
      background: linear-gradient(135deg, rgba(79, 140, 255, .12), rgba(167, 139, 250, .12));
      color: #4f8cff;
    }

    .ai-results__icon--helmet {
      background: linear-gradient(135deg, rgba(16, 185, 129, .12), rgba(52, 211, 153, .12));
      color: #10b981;
    }

    .ai-results__info {
      flex: 1;
    }

    .ai-results__label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: .06em;
      color: #94a3b8;
      margin-bottom: 2px;
    }

    .ai-results__value {
      display: block;
      font-family: var(--font-display);
      font-size: 16px;
      font-weight: 700;
      color: #0f172a;
      letter-spacing: -.01em;
    }

    /* ─── CV OVERLAY — Bounding Boxes, Scan, Grid ─── */
    .cv-overlay {
      position: absolute;
      inset: 0;
      z-index: 10;
      pointer-events: none;
      border-radius: 24px;
      overflow: hidden;
    }

    /* Fine grid */
    .cv-overlay__grid {
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(rgba(79, 140, 255, .06) 1px, transparent 1px),
        linear-gradient(90deg, rgba(79, 140, 255, .06) 1px, transparent 1px);
      background-size: 32px 32px;
      opacity: 0;
      animation: gridFadeIn .8s .5s forwards;
    }

    @keyframes gridFadeIn {
      to {
        opacity: 1;
      }
    }

    /* Moving scan line */
    .cv-overlay__scanline {
      position: absolute;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(79, 140, 255, .8), transparent);
      box-shadow: 0 0 30px 8px rgba(79, 140, 255, .2);
      animation: cvScan 3s ease-in-out infinite;
    }

    @keyframes cvScan {
      0% {
        top: -2px;
        opacity: 0;
      }

      5% {
        opacity: 1;
      }

      95% {
        opacity: 1;
      }

      100% {
        top: 100%;
        opacity: 0;
      }
    }

    /* Bounding boxes */
    .cv-bbox {
      position: absolute;
      border: 2px solid rgba(79, 140, 255, .6);
      border-radius: 6px;
      opacity: 0;
      animation: bboxAppear .4s forwards;
    }

    @keyframes bboxAppear {
      0% {
        opacity: 0;
        transform: scale(1.1);
      }

      50% {
        opacity: 1;
        transform: scale(1);
      }

      100% {
        opacity: .7;
        transform: scale(1);
      }
    }

    .cv-bbox::before {
      content: attr(data-label);
      position: absolute;
      top: -22px;
      left: -2px;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #fff;
      background: rgba(79, 140, 255, .8);
      padding: 2px 8px;
      border-radius: 4px 4px 4px 0;
      white-space: nowrap;
    }

    /* License plate bbox — amber */
    .cv-bbox--plate {
      border-color: rgba(251, 191, 36, .7);
    }

    .cv-bbox--plate::before {
      background: rgba(245, 158, 11, .85);
    }

    /* Face bbox — green with blur tag */
    .cv-bbox--face {
      border-color: rgba(52, 211, 153, .6);
      background: rgba(52, 211, 153, .08);
      backdrop-filter: blur(8px);
    }

    .cv-bbox--face::before {
      background: rgba(16, 185, 129, .85);
    }

    /* Floating detection badges on preview */
    .cv-badge {
      position: absolute;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      font-weight: 600;
      color: #fff;
      background: rgba(8, 12, 24, .75);
      backdrop-filter: blur(12px);
      padding: 6px 14px;
      border-radius: var(--radius-full);
      border: 1px solid rgba(255, 255, 255, .1);
      opacity: 0;
      transform: translateY(8px);
      transition: all .5s var(--ease-out);
    }

    .cv-badge.is-visible {
      opacity: 1;
      transform: translateY(0);
    }

    .cv-badge__dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
    }

    .cv-badge--scanning {
      bottom: 16px;
      left: 16px;
    }

    .cv-badge--scanning .cv-badge__dot {
      background: var(--blue-400);
      animation: dotPulse 1.5s infinite;
    }

    .cv-badge--blurred {
      bottom: 16px;
      right: 16px;
    }

    .cv-badge--blurred .cv-badge__dot {
      background: var(--green-400);
    }

    @keyframes dotPulse {

      0%,
      100% {
        opacity: 1;
        box-shadow: 0 0 6px rgba(79, 140, 255, .5);
      }

      50% {
        opacity: .4;
        box-shadow: none;
      }
    }

    /* Change file button */
    .evidence-stage__change {
      position: absolute;
      top: 16px;
      right: 16px;
      z-index: 20;
      font-size: 12px;
      font-weight: 600;
      color: rgba(255, 255, 255, .7);
      background: rgba(8, 12, 24, .6);
      backdrop-filter: blur(12px);
      padding: 8px 16px;
      border-radius: var(--radius-full);
      border: 1px solid rgba(255, 255, 255, .1);
      cursor: pointer;
      transition: all var(--duration-fast);
    }

    .evidence-stage__change:hover {
      color: #fff;
      border-color: rgba(255, 255, 255, .25);
    }

    /* ─── SMART FEEDBACK BADGES ─── */
    .smart-badges {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .smart-badge {
      display: inline-flex;
      align-items: center;
      gap: 7px;
      font-size: 12px;
      font-weight: 600;
      padding: 9px 18px;
      border-radius: var(--radius-full);
      background: #fff;
      border: 1px solid rgba(0, 0, 0, .06);
      color: #94a3b8;
      box-shadow: 0 2px 8px rgba(0, 0, 0, .04);
      opacity: 0;
      transform: translateY(10px);
      transition: all .5s var(--ease-out);
    }

    .smart-badge.is-active {
      opacity: 1;
      transform: translateY(0);
    }

    .smart-badge--privacy.is-active {
      border-color: rgba(16, 185, 129, .3);
      background: rgba(16, 185, 129, .08);
      color: var(--green-400);
    }

    .smart-badge--confidence.is-active {
      border-color: rgba(79, 140, 255, .3);
      background: rgba(79, 140, 255, .08);
      color: var(--blue-300);
    }

    .smart-badge--location.is-active {
      border-color: rgba(167, 139, 250, .3);
      background: rgba(167, 139, 250, .08);
      color: var(--violet-400);
    }

    .smart-badge__icon {
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* ═══════ RIGHT PANEL (40%) ═══════ */
    .studio-right {
      width: 40%;
      position: relative;
      display: flex;
      flex-direction: column;
      padding: 48px 32px;
      background: linear-gradient(175deg, #f8f9fc 0%, #ffffff 100%);
      overflow-y: auto;
      gap: 0;
    }

    .studio-right::before {
      content: '';
      position: absolute;
      width: 300px;
      height: 300px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(167, 139, 250, .06), transparent 70%);
      top: 10%;
      right: -80px;
      filter: blur(60px);
      pointer-events: none;
    }

    /* ─── AI STATUS PANEL (top of right side) ─── */
    .ai-status {
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 420px;
      margin: 0 auto 24px;
      border-radius: 24px;
      background: #fff;
      border: 1px solid rgba(0, 0, 0, .06);
      box-shadow: 0 4px 20px rgba(0, 0, 0, .04);
      padding: 28px 24px;
      display: none;
    }

    .ai-status.is-active {
      display: block;
    }

    .ai-status__header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
    }

    .ai-status__orb {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: linear-gradient(135deg, rgba(79, 140, 255, .2), rgba(167, 139, 250, .2));
      border: 1.5px solid rgba(79, 140, 255, .25);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      flex-shrink: 0;
    }

    .ai-status__orb-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--blue-400);
      box-shadow: 0 0 12px rgba(79, 140, 255, .5);
      animation: coreBreath 2s ease-in-out infinite;
    }

    .ai-status.is-complete .ai-status__orb {
      background: linear-gradient(135deg, rgba(16, 185, 129, .2), rgba(52, 211, 153, .2));
      border-color: rgba(16, 185, 129, .3);
    }

    .ai-status.is-complete .ai-status__orb-dot {
      background: var(--green-400);
      box-shadow: 0 0 12px rgba(16, 185, 129, .5);
      animation: none;
    }

    @keyframes coreBreath {

      0%,
      100% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.25);
      }
    }

    .ai-status__title {
      font-family: var(--font-display);
      font-size: 15px;
      font-weight: 700;
      color: #0f172a;
      letter-spacing: -0.01em;
    }

    .ai-status__subtitle {
      font-size: 12px;
      color: #94a3b8;
      margin-top: 2px;
    }

    /* Checklist items */
    .ai-checklist {
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    .ai-check {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 11px 0;
      border-bottom: 1px solid rgba(0, 0, 0, .04);
      transition: all .5s var(--ease-out);
    }

    .ai-check:last-child {
      border-bottom: none;
    }

    .ai-check__icon {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1.5px solid rgba(0, 0, 0, .08);
      background: rgba(0, 0, 0, .02);
      color: #cbd5e1;
      flex-shrink: 0;
      transition: all .5s var(--ease-out);
    }

    .ai-check__text {
      font-size: 13px;
      font-weight: 500;
      color: #94a3b8;
      transition: all .5s var(--ease-out);
    }

    /* Loading state — spinner */
    .ai-check.is-loading .ai-check__icon {
      border-color: var(--blue-400);
      background: rgba(79, 140, 255, .1);
      color: var(--blue-400);
      animation: checkSpin 1s linear infinite;
    }

    .ai-check.is-loading .ai-check__text {
      color: #0f172a;
    }

    @keyframes checkSpin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Done state — checkmark */
    .ai-check.is-done .ai-check__icon {
      border-color: var(--green-400);
      background: rgba(16, 185, 129, .12);
      color: var(--green-400);
      animation: none;
    }

    .ai-check.is-done .ai-check__text {
      color: #64748b;
    }

    /* Complete message */
    .ai-status__complete {
      display: none;
      margin-top: 16px;
      padding: 14px 18px;
      border-radius: 16px;
      background: rgba(16, 185, 129, .06);
      border: 1px solid rgba(16, 185, 129, .15);
      text-align: center;
    }

    .ai-status.is-complete .ai-status__complete {
      display: block;
    }

    .ai-status__complete-text {
      font-family: var(--font-display);
      font-size: 13px;
      font-weight: 600;
      color: var(--green-400);
      letter-spacing: -0.01em;
    }

    /* ─── FORM GLASS CARD ─── */
    .details-glass {
      position: relative;
      z-index: 1;
      width: 100%;
      max-width: 420px;
      margin: 0 auto;
      border-radius: 28px;
      background: #fff;
      border: 1px solid rgba(0, 0, 0, .06);
      box-shadow: 0 4px 24px rgba(0, 0, 0, .04);
      padding: 36px 28px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .details-glass__header {
      margin-bottom: 28px;
    }

    .details-glass__label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--violet-400);
      margin-bottom: 10px;
    }

    .details-glass__label svg {
      opacity: .7;
    }

    .details-glass__title {
      font-family: var(--font-display);
      font-size: 20px;
      font-weight: 700;
      color: #0f172a;
      letter-spacing: -0.02em;
    }

    /* ─── FORM FIELDS ─── */
    .studio-field {
      margin-bottom: 22px;
    }

    .studio-field__label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 10px;
    }

    .violation-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 7px;
    }

    .violation-pill {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 9px 15px;
      border-radius: var(--radius-full);
      border: 1.5px solid rgba(0, 0, 0, .08);
      background: rgba(0, 0, 0, .02);
      color: #475569;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s var(--ease-out);
      user-select: none;
    }

    .violation-pill:hover {
      border-color: rgba(79, 140, 255, .25);
      color: #1e40af;
      background: rgba(79, 140, 255, .06);
    }

    .violation-pill.is-active {
      border-color: rgba(79, 140, 255, .4);
      background: rgba(79, 140, 255, .1);
      color: #2563eb;
      box-shadow: 0 0 20px rgba(79, 140, 255, .08);
    }

    .violation-pill__icon {
      font-size: 14px;
      line-height: 1;
    }

    .studio-input-wrap {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .studio-input {
      flex: 1;
      padding: 13px 16px;
      border-radius: 14px;
      border: 1.5px solid rgba(0, 0, 0, .1);
      background: #fff;
      color: #0f172a;
      font-family: var(--font-primary);
      font-size: 13px;
      outline: none;
      transition: all 0.3s var(--ease-out);
    }

    .studio-input::placeholder {
      color: #94a3b8;
    }

    .studio-input:focus {
      border-color: rgba(79, 140, 255, .4);
      background: #fff;
      box-shadow: 0 0 20px rgba(79, 140, 255, .1);
    }

    .gps-glow-btn {
      width: 46px;
      height: 46px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, rgba(52, 211, 153, .12), rgba(79, 140, 255, .12));
      border: 1.5px solid rgba(52, 211, 153, .2);
      color: var(--green-400);
      flex-shrink: 0;
      cursor: pointer;
      transition: all 0.3s var(--ease-out);
      position: relative;
    }

    .gps-glow-btn::after {
      content: '';
      position: absolute;
      inset: -4px;
      border-radius: 18px;
      background: radial-gradient(circle, rgba(52, 211, 153, .15), transparent 70%);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .gps-glow-btn:hover {
      background: linear-gradient(135deg, rgba(52, 211, 153, .2), rgba(79, 140, 255, .2));
      border-color: rgba(52, 211, 153, .35);
      box-shadow: 0 0 30px rgba(52, 211, 153, .15);
    }

    .gps-glow-btn:hover::after {
      opacity: 1;
    }

    .gps-glow-btn.is-detecting {
      animation: gpsPing 1s ease-in-out infinite;
    }

    @keyframes gpsPing {

      0%,
      100% {
        box-shadow: 0 0 10px rgba(52, 211, 153, .15);
      }

      50% {
        box-shadow: 0 0 30px rgba(52, 211, 153, .3);
      }
    }

    .studio-textarea {
      width: 100%;
      min-height: 90px;
      padding: 14px 16px;
      border-radius: 16px;
      border: 1.5px solid rgba(0, 0, 0, .1);
      background: #fff;
      color: #0f172a;
      font-family: var(--font-primary);
      font-size: 13px;
      line-height: 1.7;
      outline: none;
      resize: vertical;
      transition: all 0.3s var(--ease-out);
    }

    .studio-textarea::placeholder {
      color: #94a3b8;
    }

    .studio-textarea:focus {
      border-color: rgba(79, 140, 255, .4);
      background: #fff;
      box-shadow: 0 0 20px rgba(79, 140, 255, .1);
    }

    /* ─── DARK SUBMIT BUTTON ─── */
    .studio-submit {
      width: 100%;
      padding: 16px 28px;
      border-radius: 18px;
      border: none;
      background: #0f172a;
      color: #fff;
      font-family: var(--font-display);
      font-size: 15px;
      font-weight: 700;
      letter-spacing: -0.01em;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      position: relative;
      overflow: hidden;
      transition: all 0.4s var(--ease-out);
      box-shadow: 0 8px 30px rgba(15, 23, 42, .15);
      margin-top: auto;
    }

    .studio-submit::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, #1e293b, #334155);
      opacity: 0;
      transition: opacity 0.4s;
    }

    .studio-submit:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(15, 23, 42, .25);
    }

    .studio-submit:hover:not(:disabled)::before {
      opacity: 1;
    }

    .studio-submit span,
    .studio-submit svg {
      position: relative;
      z-index: 1;
    }

    /* Disabled / processing state */
    .studio-submit:disabled {
      background: rgba(0, 0, 0, .06);
      color: #94a3b8;
      cursor: not-allowed;
      box-shadow: none;
    }

    .studio-submit:disabled .submit-spinner {
      display: inline-block;
    }

    .submit-spinner {
      display: none;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(0, 0, 0, .08);
      border-top-color: #64748b;
      border-radius: 50%;
      animation: checkSpin .8s linear infinite;
      position: relative;
      z-index: 1;
    }

    /* Glow ripple when enabled after AI */
    .studio-submit.is-ready {
      animation: submitGlow 2s ease-in-out infinite;
    }

    @keyframes submitGlow {

      0%,
      100% {
        box-shadow: 0 8px 30px rgba(15, 23, 42, .15), 0 0 0 0 rgba(79, 140, 255, .08);
      }

      50% {
        box-shadow: 0 8px 30px rgba(15, 23, 42, .2), 0 0 0 8px rgba(79, 140, 255, .05);
      }
    }

    .studio-submit__note {
      text-align: center;
      margin-top: 14px;
      font-size: 11px;
      color: #94a3b8;
      line-height: 1.6;
    }

    .studio-submit__note svg {
      vertical-align: -2px;
      margin-right: 4px;
      opacity: .5;
    }

    /* ─── RESPONSIVE ─── */
    @media (max-width: 1024px) {
      .studio-main {
        flex-direction: column;
      }

      .studio-left,
      .studio-right {
        width: 100%;
      }

      .studio-left {
        min-height: 55vh;
        padding: 40px 24px;
      }

      .studio-right {
        padding: 40px 24px;
      }
    }

    @media (max-width: 640px) {
      .studio-topbar {
        padding: 12px 16px;
      }

      .studio-topbar__tag {
        display: none;
      }

      .studio-left {
        padding: 32px 16px;
        min-height: 50vh;
      }

      .studio-right {
        padding: 24px 16px;
      }

      .upload-glass {
        padding: 32px 20px;
        border-radius: 22px;
      }

      .upload-glass__icon {
        width: 68px;
        height: 68px;
      }

      .upload-glass__title {
        font-size: 22px;
      }

      .card-stack {
        height: 280px;
      }

      .details-glass {
        padding: 24px 18px;
        border-radius: 22px;
      }

      .violation-pill {
        padding: 7px 12px;
        font-size: 11px;
      }

      .studio-submit {
        padding: 14px 20px;
        font-size: 14px;
        border-radius: 14px;
      }

      .smart-badges {
        gap: 6px;
      }

      .smart-badge {
        font-size: 11px;
        padding: 7px 12px;
      }

      .plate-entry {
        padding: 16px 18px;
        border-radius: 16px;
      }

      .plate-entry__input {
        font-size: 14px;
        padding: 10px 14px;
      }

      .ai-results__card {
        padding: 12px 16px;
      }

      .ai-results__value {
        font-size: 14px;
      }

      .evidence-stage__delete {
        width: 36px;
        height: 36px;
        top: 8px;
        left: 8px;
      }

      .hud-ring {
        width: 48px;
        height: 48px;
      }

      .hud-ring svg {
        width: 48px;
        height: 48px;
      }

      .hud-status {
        font-size: 11px;
      }

      .hud-cam-id,
      .hud-timestamp {
        font-size: 8px;
      }

      .hud-detect-label {
        font-size: 8px;
      }
    }
  </style>
</head>

<body class="studio-body">

  <!-- ═══ FLOATING TOP BAR ═══ -->
  <div class="studio-topbar">
    <div style="display:flex;align-items:center;gap:16px;">
      <a href="index.html" class="studio-topbar__logo">
        <svg width="24" height="24" viewBox="0 0 28 28" fill="none">
          <circle cx="14" cy="14" r="12" stroke="url(#stLogoG)" stroke-width="2.5" />
          <path d="M9 14.5L12.5 18L19 11" stroke="url(#stLogoG)" stroke-width="2.5" stroke-linecap="round"
            stroke-linejoin="round" />
          <defs>
            <linearGradient id="stLogoG" x1="0" y1="0" x2="28" y2="28">
              <stop stop-color="#4F8CFF" />
              <stop offset="1" stop-color="#A78BFA" />
            </linearGradient>
          </defs>
        </svg>
        SARAL
      </a>
      <span class="studio-topbar__tag">
        <svg width="10" height="10" viewBox="0 0 10 10" fill="currentColor">
          <circle cx="5" cy="5" r="3" />
        </svg>
        AI Reporting Studio
      </span>
    </div>
    <a href="dashboard.html" class="studio-topbar__back">
      <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
        <path d="M10 7H4M7 4L4 7l3 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
          stroke-linejoin="round" />
      </svg>
      Back to Dashboard
    </a>
  </div>

  <!-- ═══ MAIN SPLIT LAYOUT ═══ -->
  <div class="studio-main">

    <!-- ─── LEFT: EVIDENCE ZONE (60%) ─── -->
    <div class="studio-left">
      <div class="studio-left__grid"></div>

      <!-- Upload Glass Panel (before upload) -->
      <div class="upload-glass" id="uploadZone">
        <div class="upload-glass__border"></div>
        <div class="upload-glass__icon">
          <svg width="36" height="36" viewBox="0 0 24 24" fill="none" style="position:relative;z-index:1">
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" stroke="currentColor" stroke-width="1.5"
              stroke-linecap="round" stroke-linejoin="round" />
            <polyline points="17 8 12 3 7 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
              stroke-linejoin="round" />
            <line x1="12" y1="3" x2="12" y2="15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
          </svg>
        </div>
        <h2 class="upload-glass__title">Upload Evidence</h2>
        <p class="upload-glass__desc">
          Photos or videos up to <strong>50 MB</strong>. Faces are <strong>automatically blurred</strong> for privacy.
        </p>
        <div class="upload-glass__formats">
          <span class="upload-glass__format">JPG</span>
          <span class="upload-glass__format">PNG</span>
          <span class="upload-glass__format">MP4</span>
          <span class="upload-glass__format">HEIC</span>
          <span class="upload-glass__format">WEBM</span>
        </div>
        <input type="file" id="fileInput" hidden accept="image/*,video/*" multiple />
      </div>

      <!-- Evidence Stage (after upload — card stack + CV overlay + badges) -->
      <div class="evidence-stage" id="evidenceStage">
        <!-- Card stack -->
        <div class="card-stack" id="cardStack">
          <!-- Primary card (front) -->
          <div class="card-stack__item" id="card1">
            <img id="previewImg1" src="" alt="Evidence" />
            <!-- CV Overlay -->
            <div class="cv-overlay" id="cvOverlay">
              <div class="cv-overlay__grid"></div>
              <div class="cv-overlay__scanline"></div>
              <!-- Bounding boxes injected by JS -->
            </div>
            <!-- CV Badges on image -->
            <div class="cv-badge cv-badge--scanning" id="badgeScanning">
              <div class="cv-badge__dot"></div>
              AI Analyzing Evidence...
            </div>
            <div class="cv-badge cv-badge--blurred" id="badgeBlurred">
              <div class="cv-badge__dot"></div>
              Faces Blurred
            </div>
          </div>
          <!-- Shadow cards behind -->
          <div class="card-stack__item" id="card2">
            <img id="previewImg2" src="" alt="" />
          </div>
          <div class="card-stack__item" id="card3">
            <img id="previewImg3" src="" alt="" />
          </div>

          <!-- AI Vision Scanning HUD Overlay (inside card-stack so it only covers the image) -->
          <div class="processing-overlay" id="processingOverlay">
            <!-- 1. Dark blur backdrop -->
            <div class="hud-backdrop"></div>
            <!-- 3. Grid overlay -->
            <div class="hud-grid"></div>
            <!-- Crosshair lines -->
            <div class="hud-crosshair"></div>
            <!-- 2. Scanning neon line -->
            <div class="hud-scanline"></div>
            <!-- 7. Particle canvas -->
            <canvas class="hud-particles" id="hudParticles"></canvas>
            <!-- 4. Detection box -->
            <div class="hud-detect-box" id="hudDetectBox">
              <span class="hud-corner-tr"></span>
              <span class="hud-corner-bl"></span>
              <span class="hud-detect-label" id="hudDetectLabel">DETECTING...</span>
            </div>
            <!-- 5. AI Loader Ring -->
            <div class="hud-ring">
              <svg viewBox="0 0 64 64">
                <circle class="hud-ring-track" cx="32" cy="32" r="28" />
                <circle class="hud-ring-progress" cx="32" cy="32" r="28" />
                <defs>
                  <linearGradient id="hudRingGrad" x1="0" y1="0" x2="64" y2="64">
                    <stop stop-color="#00fffe" />
                    <stop offset="1" stop-color="#0ea5e9" />
                  </linearGradient>
                </defs>
              </svg>
            </div>
            <!-- 6. Dynamic status text -->
            <div class="hud-status" id="hudStatus"><span>Initializing scanner...</span></div>
            <!-- HUD metadata -->
            <span class="hud-cam-id"><span class="hud-rec-dot"></span>SARAL-CAM // AI-VISION v2.1</span>
            <span class="hud-timestamp" id="hudTimestamp">00:00:00</span>
          </div>
        </div>

        <!-- Delete / Remove Upload button -->
        <button class="evidence-stage__delete" id="deleteUploadBtn" title="Remove upload">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <polyline points="3 6 5 6 21 6" />
            <path d="M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2" />
            <line x1="10" y1="11" x2="10" y2="17" />
            <line x1="14" y1="11" x2="14" y2="17" />
          </svg>
        </button>

        <!-- Change file -->
        <button class="evidence-stage__change" id="changeFileBtn">Change File</button>

        <!-- Smart Feedback Badges -->
        <div class="smart-badges">
          <div class="smart-badge smart-badge--privacy" id="sbPrivacy">
            <span class="smart-badge__icon">
              <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                <path d="M7 1.5L3 3.5v3c0 3.3 1.7 6.3 4 7 2.3-.7 4-3.7 4-7v-3L7 1.5z" stroke="currentColor"
                  stroke-width="1.2" />
                <path d="M5 7l1.5 1.5L9 6" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"
                  stroke-linejoin="round" />
              </svg>
            </span>
            Privacy Protected
          </div>
          <div class="smart-badge smart-badge--confidence" id="sbConfidence">
            <span class="smart-badge__icon">
              <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                <path d="M7 1l1.76 3.57L13 5.24l-3 2.92.71 4.14L7 10.38 3.29 12.3 4 8.16 1 5.24l4.24-.67L7 1z"
                  stroke="currentColor" stroke-width="1.2" stroke-linejoin="round" />
              </svg>
            </span>
            High Detection Confidence
          </div>
          <div class="smart-badge smart-badge--location" id="sbLocation">
            <span class="smart-badge__icon">
              <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
                <circle cx="7" cy="6" r="2" stroke="currentColor" stroke-width="1.2" />
                <path d="M7 13S2.5 8.5 2.5 6a4.5 4.5 0 019 0C11.5 8.5 7 13 7 13z" stroke="currentColor"
                  stroke-width="1.2" />
              </svg>
            </span>
            Location Verified
          </div>
        </div>

        <!-- Manual Plate Entry -->
        <div class="plate-entry" id="plateEntry">
          <label class="plate-entry__label">Know the plate number? <strong>Enter it (optional)</strong></label>
          <div class="plate-entry__row">
            <input type="text" class="plate-entry__input" id="manualPlateInput" placeholder="KA01AB1234" maxlength="15"
              autocomplete="off" />
          </div>
          <span class="plate-entry__hint">Format: KA01AB1234 — only A-Z and 0-9 allowed</span>
        </div>

        <!-- Plate Verification Badge -->
        <div class="plate-verify-badge" id="plateVerifyBadge">
          <span class="plate-verify-badge__pulse"></span>
          <span id="plateVerifyText"></span>
        </div>

        <!-- AI Results Display -->
        <div class="ai-results" id="aiResultsDisplay">
          <div class="ai-results__card">
            <div class="ai-results__icon ai-results__icon--plate">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                <rect x="2" y="6" width="20" height="12" rx="3" />
                <path d="M6 12h4M6 15h2" />
                <circle cx="18" cy="11" r="2" />
              </svg>
            </div>
            <div class="ai-results__info">
              <span class="ai-results__label">Plate Number</span>
              <span class="ai-results__value" id="resultPlate">—</span>
            </div>
          </div>
          <div class="ai-results__card">
            <div class="ai-results__icon ai-results__icon--violation">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                <path d="M12 9v4M12 17h.01" />
                <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z" />
              </svg>
            </div>
            <div class="ai-results__info">
              <span class="ai-results__label">Violation Type</span>
              <span class="ai-results__value" id="resultViolation">—</span>
            </div>
          </div>
          <div class="ai-results__card">
            <div class="ai-results__icon ai-results__icon--confidence">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                <path
                  d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" />
              </svg>
            </div>
            <div class="ai-results__info">
              <span class="ai-results__label">Confidence Score</span>
              <span class="ai-results__value" id="resultConfidence">—</span>
            </div>
          </div>
          <div class="ai-results__card" id="resultHelmetCard" style="display:none">
            <div class="ai-results__icon ai-results__icon--helmet">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8">
                <path d="M12 2C6.48 2 2 6.48 2 12v6h4v-6c0-3.31 2.69-6 6-6s6 2.69 6 6v6h4v-6c0-5.52-4.48-10-10-10z" />
              </svg>
            </div>
            <div class="ai-results__info">
              <span class="ai-results__label">Helmet Detection</span>
              <span class="ai-results__value" id="resultHelmet">—</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ─── RIGHT: STATUS + FORM (40%) ─── -->
    <div class="studio-right">

      <!-- AI Processing Status Panel -->
      <div class="ai-status" id="aiStatus">
        <div class="ai-status__header">
          <div class="ai-status__orb">
            <div class="ai-status__orb-dot"></div>
          </div>
          <div>
            <div class="ai-status__title" id="aiStatusTitle">AI Analysis in Progress</div>
            <div class="ai-status__subtitle" id="aiStatusSub">Processing your evidence...</div>
          </div>
        </div>
        <div class="ai-checklist" id="aiChecklist">
          <div class="ai-check" data-step="0">
            <div class="ai-check__icon">
              <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                <circle cx="6" cy="6" r="4" stroke="currentColor" stroke-width="1.2" />
              </svg>
            </div>
            <span class="ai-check__text">Detecting violation type</span>
          </div>
          <div class="ai-check" data-step="1">
            <div class="ai-check__icon">
              <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                <rect x="2" y="3" width="8" height="5" rx="1" stroke="currentColor" stroke-width="1.2" />
                <path d="M4 6h4" stroke="currentColor" stroke-width="1" />
              </svg>
            </div>
            <span class="ai-check__text">Reading number plate</span>
          </div>
          <div class="ai-check" data-step="2">
            <div class="ai-check__icon">
              <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                <circle cx="6" cy="5" r="2" stroke="currentColor" stroke-width="1.2" />
                <path d="M2 10c0-2.2 1.8-4 4-4s4 1.8 4 4" stroke="currentColor" stroke-width="1.2" />
              </svg>
            </div>
            <span class="ai-check__text">Blurring faces</span>
          </div>
          <div class="ai-check" data-step="3">
            <div class="ai-check__icon">
              <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                <circle cx="6" cy="5.5" r="2" stroke="currentColor" stroke-width="1.2" />
                <path d="M6 1v1M6 10v1M1 5.5h1M10 5.5h1" stroke="currentColor" stroke-width="1"
                  stroke-linecap="round" />
              </svg>
            </div>
            <span class="ai-check__text">Verifying location metadata</span>
          </div>
          <div class="ai-check" data-step="4">
            <div class="ai-check__icon">
              <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                <path d="M6 1L3 3v3c0 2.7 1.3 5.2 3 5.8 1.7-.6 3-3.1 3-5.8V3L6 1z" stroke="currentColor"
                  stroke-width="1.2" />
              </svg>
            </div>
            <span class="ai-check__text">Preparing for authority review</span>
          </div>
        </div>
        <div class="ai-status__complete">
          <div class="ai-status__complete-text">AI Analysis Complete — Ready for Authority Review</div>
        </div>
      </div>

      <!-- Form Glass Card -->
      <div class="details-glass">
        <div class="details-glass__header">
          <div class="details-glass__label">
            <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
              <path d="M6 1v10M1 6h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
            </svg>
            Report Details
          </div>
          <h2 class="details-glass__title">Describe the Violation</h2>
        </div>

        <form id="reportForm">
          <!-- Violation Type Pills -->
          <div class="studio-field">
            <label class="studio-field__label">Violation Type</label>
            <div class="violation-pills" id="violationPills">
              <div class="violation-pill" data-value="signal">
                <span class="violation-pill__icon">🚦</span> Signal Jumping
              </div>
              <div class="violation-pill" data-value="speeding">
                <span class="violation-pill__icon">💨</span> Over Speeding
              </div>
              <div class="violation-pill" data-value="wrongway">
                <span class="violation-pill__icon">🚫</span> Wrong Way
              </div>
              <div class="violation-pill" data-value="parking">
                <span class="violation-pill__icon">🅿️</span> Illegal Parking
              </div>
              <div class="violation-pill" data-value="helmet">
                <span class="violation-pill__icon">⛑️</span> No Helmet
              </div>
              <div class="violation-pill" data-value="seatbelt">
                <span class="violation-pill__icon">🔗</span> No Seatbelt
              </div>
              <div class="violation-pill" data-value="phone">
                <span class="violation-pill__icon">📱</span> Phone Use
              </div>
              <div class="violation-pill" data-value="other">
                <span class="violation-pill__icon">⚠️</span> Other
              </div>
            </div>
            <input type="hidden" id="violationType" name="violationType" />
          </div>

          <!-- Location -->
          <div class="studio-field">
            <label class="studio-field__label">Location</label>
            <div class="studio-input-wrap">
              <input type="text" class="studio-input" placeholder="Enter location or detect via GPS"
                id="locationInput" />
              <button type="button" class="gps-glow-btn" id="gpsBtn" title="Detect GPS Location">
                <svg width="18" height="18" viewBox="0 0 20 20" fill="none" style="position:relative;z-index:1">
                  <circle cx="10" cy="10" r="3" stroke="currentColor" stroke-width="1.5" />
                  <path d="M10 2v3M10 15v3M2 10h3M15 10h3" stroke="currentColor" stroke-width="1.5"
                    stroke-linecap="round" />
                </svg>
              </button>
            </div>
          </div>

          <!-- Description -->
          <div class="studio-field">
            <label class="studio-field__label">Description <span
                style="opacity:.5;text-transform:none;letter-spacing:0">(optional)</span></label>
            <textarea class="studio-textarea"
              placeholder="What happened? Where and when did you observe this?"></textarea>
          </div>

          <!-- Submit -->
          <div class="studio-field" style="margin-bottom:0;margin-top:auto;">
            <button type="submit" class="studio-submit" id="submitBtn" disabled>
              <div class="submit-spinner"></div>
              <span id="submitText">Upload evidence to begin</span>
              <svg id="submitArrow" width="18" height="18" viewBox="0 0 18 18" fill="none" style="display:none">
                <path d="M3.75 9h10.5M10.5 5.25L14.25 9l-3.75 3.75" stroke="currentColor" stroke-width="1.5"
                  stroke-linecap="round" stroke-linejoin="round" />
              </svg>
            </button>
            <p class="studio-submit__note">
              <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
                <path d="M6 1L2 3.5v3C2 9.8 3.7 13 6 13.8c2.3-.8 4-4 4-7.3v-3L6 1z" stroke="currentColor"
                  stroke-width="1" />
              </svg>
              Your identity is protected. Authorities review every report.
            </p>
          </div>
        </form>
      </div>
    </div>

  </div>

  <!-- ═══ JAVASCRIPT ═══ -->
  <script src="js/api.js"></script>
  <script src="js/store.js"></script>
  <script src="js/auth.js"></script>
  <script>SaralAuth.requireAuth('user');</script>
  <script>
    (function () {
      'use strict';

      /* ─── DOM REFS ─── */
      const uploadZone = document.getElementById('uploadZone');
      const fileInput = document.getElementById('fileInput');
      const evidenceStage = document.getElementById('evidenceStage');
      const cardStack = document.getElementById('cardStack');
      const previewImg1 = document.getElementById('previewImg1');
      const previewImg2 = document.getElementById('previewImg2');
      const previewImg3 = document.getElementById('previewImg3');
      const cvOverlay = document.getElementById('cvOverlay');
      const changeBtn = document.getElementById('changeFileBtn');
      const aiStatus = document.getElementById('aiStatus');
      const submitBtn = document.getElementById('submitBtn');
      const submitText = document.getElementById('submitText');
      const submitArrow = document.getElementById('submitArrow');
      const badgeScanning = document.getElementById('badgeScanning');
      const badgeBlurred = document.getElementById('badgeBlurred');

      const processingOverlay = document.getElementById('processingOverlay');
      const deleteBtn = document.getElementById('deleteUploadBtn');
      const manualPlateInput = document.getElementById('manualPlateInput');
      const plateVerifyBadge = document.getElementById('plateVerifyBadge');
      const plateVerifyText = document.getElementById('plateVerifyText');
      const aiResultsDisplay = document.getElementById('aiResultsDisplay');

      /* ─── HUD CONTROLLER ─── */
      const hudStatus = document.getElementById('hudStatus');
      const hudDetectBox = document.getElementById('hudDetectBox');
      const hudDetectLabel = document.getElementById('hudDetectLabel');
      const hudTimestamp = document.getElementById('hudTimestamp');
      const hudParticlesCanvas = document.getElementById('hudParticles');

      const HUD_MESSAGES = [
        'Scanning scene...',
        'Detecting vehicle...',
        'Locating number plate...',
        'Reading plate characters...',
        'Analyzing violation...',
      ];
      let hudMsgInterval = null;
      let hudTimerInterval = null;
      let hudParticleRAF = null;

      function startHUD() {
        // Cycling status messages
        let msgIdx = 0;
        hudStatus.innerHTML = `<span>${HUD_MESSAGES[0]}</span>`;
        hudMsgInterval = setInterval(() => {
          msgIdx = (msgIdx + 1) % HUD_MESSAGES.length;
          hudStatus.innerHTML = `<span>${HUD_MESSAGES[msgIdx]}</span>`;
        }, 2400);

        // Live timestamp
        const t0 = Date.now();
        hudTimerInterval = setInterval(() => {
          const s = Math.floor((Date.now() - t0) / 1000);
          const mm = String(Math.floor(s / 60)).padStart(2, '0');
          const ss = String(s % 60).padStart(2, '0');
          const ms = String(Math.floor((Date.now() - t0) % 1000 / 10)).padStart(2, '0');
          hudTimestamp.textContent = `${mm}:${ss}:${ms}`;
        }, 50);

        // Show detection box after 800ms
        setTimeout(() => {
          hudDetectBox.classList.add('is-visible');
          hudDetectLabel.textContent = 'DETECTING...';
        }, 800);

        // Start particle effect
        startParticles();
      }

      function stopHUD() {
        clearInterval(hudMsgInterval);
        clearInterval(hudTimerInterval);
        hudMsgInterval = null;
        hudTimerInterval = null;
        cancelAnimationFrame(hudParticleRAF);
        hudParticleRAF = null;
        const ctx = hudParticlesCanvas.getContext('2d');
        ctx.clearRect(0, 0, hudParticlesCanvas.width, hudParticlesCanvas.height);
      }

      function resetHUD() {
        stopHUD();
        hudDetectBox.classList.remove('is-visible');
        hudStatus.innerHTML = '';
        hudTimestamp.textContent = '00:00:00';
        hudDetectLabel.textContent = 'DETECTING...';
      }

      /* ─── PARTICLE ENGINE (tiny dots along scan region) ─── */
      function startParticles() {
        const canvas = hudParticlesCanvas;
        const parent = canvas.parentElement;
        canvas.width = parent.offsetWidth || 400;
        canvas.height = parent.offsetHeight || 300;
        const ctx = canvas.getContext('2d');
        const particles = [];

        function spawnBatch() {
          const count = 3 + Math.floor(Math.random() * 4);
          for (let i = 0; i < count; i++) {
            particles.push({
              x: Math.random() * canvas.width,
              y: Math.random() * canvas.height,
              r: 1 + Math.random() * 1.5,
              life: 0,
              maxLife: 30 + Math.random() * 40,
              vx: (Math.random() - .5) * .6,
              vy: (Math.random() - .5) * .6,
            });
          }
        }

        let frame = 0;
        function tick() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          if (frame % 8 === 0) spawnBatch();
          for (let i = particles.length - 1; i >= 0; i--) {
            const p = particles[i];
            p.life++;
            p.x += p.vx;
            p.y += p.vy;
            const alpha = 1 - p.life / p.maxLife;
            if (alpha <= 0) { particles.splice(i, 1); continue; }
            ctx.beginPath();
            ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(0, 255, 255, ${alpha * .5})`;
            ctx.shadowColor = 'rgba(0, 255, 255, .3)';
            ctx.shadowBlur = 4;
            ctx.fill();
          }
          frame++;
          hudParticleRAF = requestAnimationFrame(tick);
        }
        tick();
      }

      let selectedFile = null;
      let aiResult = null;
      let aiComplete = false;

      /* ─── MANUAL PLATE VALIDATION (A-Z 0-9 only) ─── */
      if (manualPlateInput) {
        manualPlateInput.addEventListener('input', function () {
          this.value = this.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
          this.classList.toggle('is-invalid', this.value.length > 0 && this.value.length < 4);
        });
      }

      function normalizePlate(str) {
        return (str || '').toUpperCase().replace(/[^A-Z0-9]/g, '');
      }

      /* ─── SHOW EVIDENCE + START AI ANALYSIS ─── */
      function showEvidence(file) {
        if (!file) return;
        selectedFile = file;
        const reader = new FileReader();
        reader.onload = e => {
          const src = e.target.result;
          previewImg1.src = src;
          previewImg2.src = src;
          previewImg3.src = src;

          uploadZone.classList.add('is-hidden');
          evidenceStage.classList.add('is-active');

          // Show processing overlay with HUD
          processingOverlay.classList.remove('is-done');
          processingOverlay.classList.add('is-active');
          startHUD();

          // Start AI scanning animation + backend call
          submitBtn.disabled = true;
          submitText.textContent = 'AI Analyzing Evidence...';
          submitArrow.style.display = 'none';
          startAIScan(file);
        };
        reader.readAsDataURL(file);
      }

      function resetUpload() {
        uploadZone.classList.remove('is-hidden');
        evidenceStage.classList.remove('is-active');
        previewImg1.src = '';
        previewImg2.src = '';
        previewImg3.src = '';
        fileInput.value = '';
        selectedFile = null;
        aiResult = null;
        aiComplete = false;

        // Reset processing overlay
        processingOverlay.classList.remove('is-active', 'is-done');
        resetHUD();

        // Reset AI status
        aiStatus.classList.remove('is-active', 'is-complete');
        document.querySelectorAll('.ai-check').forEach(c => {
          c.classList.remove('is-loading', 'is-done');
          c.querySelector('.ai-check__icon').innerHTML = c.querySelector('.ai-check__icon').dataset.original || c.querySelector('.ai-check__icon').innerHTML;
        });
        document.getElementById('aiStatusTitle').textContent = 'AI Analysis in Progress';
        document.getElementById('aiStatusSub').textContent = 'Processing your evidence...';

        // Reset badges
        badgeScanning.classList.remove('is-visible');
        badgeBlurred.classList.remove('is-visible');
        document.querySelectorAll('.smart-badge').forEach(b => b.classList.remove('is-active'));

        // Remove injected bboxes
        cvOverlay.querySelectorAll('.cv-bbox').forEach(b => b.remove());

        // Reset manual plate + verification
        if (manualPlateInput) manualPlateInput.value = '';
        plateVerifyBadge.classList.remove('is-visible', 'plate-verify-badge--match', 'plate-verify-badge--mismatch');
        plateVerifyBadge.style.display = 'none';

        // Reset AI results display
        aiResultsDisplay.classList.remove('is-visible');

        // Reset submit
        submitBtn.disabled = true;
        submitBtn.classList.remove('is-ready');
        submitText.textContent = 'Upload evidence to begin';
        submitArrow.style.display = 'none';
      }

      /* ─── UPLOAD EVENTS ─── */
      if (uploadZone && fileInput) {
        uploadZone.addEventListener('click', () => fileInput.click());
        uploadZone.addEventListener('dragover', e => {
          e.preventDefault();
          uploadZone.classList.add('is-dragover');
        });
        uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('is-dragover'));
        uploadZone.addEventListener('drop', e => {
          e.preventDefault();
          uploadZone.classList.remove('is-dragover');
          if (e.dataTransfer.files.length) {
            fileInput.files = e.dataTransfer.files;
            showEvidence(e.dataTransfer.files[0]);
          }
        });
        fileInput.addEventListener('change', () => {
          if (fileInput.files.length) showEvidence(fileInput.files[0]);
        });
      }
      if (changeBtn) changeBtn.addEventListener('click', resetUpload);
      if (deleteBtn) deleteBtn.addEventListener('click', resetUpload);

      /* ─── AI SCANNING SEQUENCE ─── */
      function startAIScan(file) {
        aiStatus.classList.add('is-active');
        const checks = document.querySelectorAll('.ai-check');
        let step = 0;
        let apiDone = false;

        // Save original icons
        checks.forEach(c => {
          const ico = c.querySelector('.ai-check__icon');
          ico.dataset.original = ico.innerHTML;
        });

        // Badge: scanning visible immediately
        setTimeout(() => badgeScanning.classList.add('is-visible'), 300);

        // Bounding boxes appear at step 0
        setTimeout(() => injectBoundingBoxes(), 800);

        // Start the real backend analysis call
        const userId = SaralAuth.getUserId();
        const violationType = document.getElementById('violationType').value || '';
        const location = document.getElementById('locationInput').value || '';
        const description = document.querySelector('.studio-textarea')?.value || '';

        const manualPlate = manualPlateInput ? manualPlateInput.value.trim() : '';
        SaralAPI.analyze(file, userId, violationType, location, description, manualPlate)
          .then(result => {
            aiResult = result;
            apiDone = true;
            console.log('[Report] AI result:', result);

            // Auto-select violation type pill if detected
            if (result.violation) {
              const lcViol = result.violation.toLowerCase();
              document.querySelectorAll('.violation-pill').forEach(p => {
                const pv = p.dataset.value.toLowerCase();
                if (lcViol.includes(pv) || (pv === 'helmet' && lcViol.includes('helmet'))) {
                  document.querySelectorAll('.violation-pill').forEach(pp => pp.classList.remove('is-active'));
                  p.classList.add('is-active');
                  document.getElementById('violationType').value = p.dataset.value;
                }
              });
            }
          })
          .catch(err => {
            console.error('[Report] AI analysis failed:', err);
            SaralToast.show('AI analysis failed: ' + err.message, 'error');
            apiDone = true;
          });

        function nextStep() {
          if (step > 0) {
            const prev = checks[step - 1];
            prev.classList.remove('is-loading');
            prev.classList.add('is-done');
            prev.querySelector('.ai-check__icon').innerHTML =
              '<svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M3 6l2 2 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>';
          }

          // Trigger side events at specific steps
          if (step === 2) {
            badgeBlurred.classList.add('is-visible');
            badgeScanning.querySelector('.cv-badge__dot').nextSibling.textContent = ' AI Analysis Active';
            document.getElementById('sbPrivacy').classList.add('is-active');
          }
          if (step === 1) {
            document.getElementById('sbConfidence').classList.add('is-active');
            // Show actual confidence value if we have it
            if (aiResult && aiResult.confidence) {
              const sbConf = document.getElementById('sbConfidence');
              sbConf.innerHTML = `
                <span class="smart-badge__icon">
                  <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M7 1l1.76 3.57L13 5.24l-3 2.92.71 4.14L7 10.38 3.29 12.3 4 8.16 1 5.24l4.24-.67L7 1z" stroke="currentColor" stroke-width="1.2" stroke-linejoin="round"/></svg>
                </span>
                AI Confidence: ${aiResult.confidence}%
              `;
            }
          }
          if (step === 3) {
            document.getElementById('sbLocation').classList.add('is-active');
          }

          if (step < checks.length) {
            // If we're at last step and API isn't done, wait
            if (step === checks.length - 1 && !apiDone) {
              checks[step].classList.add('is-loading');
              checks[step].querySelector('.ai-check__icon').innerHTML =
                '<svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M6 2v2M6 8v2M2 6h2M8 6h2" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/></svg>';
              // Poll until apiDone
              const poll = setInterval(() => {
                if (apiDone) {
                  clearInterval(poll);
                  step++;
                  nextStep();
                }
              }, 300);
              return;
            }

            checks[step].classList.add('is-loading');
            checks[step].querySelector('.ai-check__icon').innerHTML =
              '<svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M6 2v2M6 8v2M2 6h2M8 6h2" stroke="currentColor" stroke-width="1.3" stroke-linecap="round"/></svg>';
            step++;
            setTimeout(nextStep, 1200 + Math.random() * 600);
          } else {
            // All done
            onAIComplete();
          }
        }

        setTimeout(nextStep, 600);
      }

      function onAIComplete() {
        aiComplete = true;
        aiStatus.classList.add('is-complete');

        // Update detection box label to final result
        if (aiResult && aiResult.violation) {
          hudDetectLabel.textContent = aiResult.violation.toUpperCase();
        } else {
          hudDetectLabel.textContent = 'ANALYSIS COMPLETE';
        }

        // Stop HUD intervals + particles
        stopHUD();

        // Smoothly transition out — blur fades, HUD elements fade via CSS
        processingOverlay.classList.add('is-done');
        setTimeout(() => processingOverlay.classList.remove('is-active'), 1000);

        // Show real results
        if (aiResult) {
          const plate = aiResult.plate || 'Not detected';
          const conf = aiResult.confidence || 0;
          const violation = aiResult.violation || 'Traffic Violation';
          const helmet = aiResult.helmet_detected || '';
          let subtitle = `Plate: ${plate} | Confidence: ${conf}%`;
          if (helmet) subtitle += ` | ${helmet}`;
          document.getElementById('aiStatusTitle').textContent = '✓ ' + violation + ' Detected';
          document.getElementById('aiStatusSub').textContent = subtitle;

          // Populate AI results cards
          document.getElementById('resultPlate').textContent = plate;
          document.getElementById('resultViolation').textContent = violation;
          document.getElementById('resultConfidence').textContent = conf + '%';
          if (helmet) {
            document.getElementById('resultHelmet').textContent = helmet;
            document.getElementById('resultHelmetCard').style.display = 'flex';
          }
          aiResultsDisplay.classList.add('is-visible');

          // Plate match verification
          const manualRaw = (manualPlateInput ? manualPlateInput.value : '').trim();
          if (manualRaw.length >= 4 && aiResult.plate) {
            const normManual = normalizePlate(manualRaw);
            const normOCR = normalizePlate(aiResult.plate);
            const isMatch = normManual === normOCR;

            plateVerifyBadge.className = 'plate-verify-badge is-visible ' +
              (isMatch ? 'plate-verify-badge--match' : 'plate-verify-badge--mismatch');
            plateVerifyBadge.style.display = 'inline-flex';
            plateVerifyText.textContent = isMatch
              ? '✔ Plate Verified — Manual entry matches AI reading'
              : '⚠ Plate differs from AI reading — using OCR result';
          }

          // Backend match info
          if (aiResult.match === true) {
            plateVerifyBadge.className = 'plate-verify-badge is-visible plate-verify-badge--match';
            plateVerifyBadge.style.display = 'inline-flex';
            plateVerifyText.textContent = '✔ Plate Verified — Manual entry matches AI reading';
          } else if (aiResult.match === false && aiResult.manual_plate) {
            plateVerifyBadge.className = 'plate-verify-badge is-visible plate-verify-badge--mismatch';
            plateVerifyBadge.style.display = 'inline-flex';
            plateVerifyText.textContent = '⚠ Plate differs from AI reading — using OCR result';
          }

        } else {
          document.getElementById('aiStatusTitle').textContent = 'Analysis Complete';
          document.getElementById('aiStatusSub').textContent = 'Ready for authority review';
        }

        // Update scanning badge
        badgeScanning.innerHTML =
          '<div class="cv-badge__dot" style="background:var(--green-400);animation:none"></div> Analysis Complete';

        // Enable submit
        submitBtn.disabled = false;
        submitBtn.classList.add('is-ready');
        submitText.textContent = aiResult ? 'Report Submitted — View My Reports' : 'Submit for Authority Review';
        submitArrow.style.display = '';

        // If analysis succeeded, report is already created; button just navigates
        if (aiResult && aiResult.report_id) {
          SaralToast.show(`Report created! Plate: ${aiResult.plate || 'N/A'}, Confidence: ${aiResult.confidence}%`, 'success');
        }
      }

      /* ─── INJECT CV BOUNDING BOXES ─── */
      function injectBoundingBoxes() {
        const bboxes = [
          { top: '22%', left: '10%', w: '35%', h: '45%', label: 'Vehicle', cls: '', delay: 0 },
          { top: '30%', left: '55%', w: '22%', h: '30%', label: 'Vehicle', cls: '', delay: 400 },
          { top: '58%', left: '18%', w: '18%', h: '10%', label: 'License Plate', cls: 'cv-bbox--plate', delay: 1200 },
          { top: '12%', left: '62%', w: '12%', h: '16%', label: 'Face Blurred', cls: 'cv-bbox--face', delay: 2000 },
        ];

        bboxes.forEach(b => {
          setTimeout(() => {
            const el = document.createElement('div');
            el.className = 'cv-bbox ' + b.cls;
            el.dataset.label = b.label;
            el.style.cssText = 'top:' + b.top + ';left:' + b.left + ';width:' + b.w + ';height:' + b.h + ';';
            cvOverlay.appendChild(el);

            if (!b.cls) {
              setTimeout(() => {
                el.style.transition = 'opacity 1s';
                el.style.opacity = '.3';
              }, 2500);
            }
          }, b.delay);
        });
      }

      /* ─── VIOLATION PILL SELECTORS ─── */
      document.querySelectorAll('.violation-pill').forEach(pill => {
        pill.addEventListener('click', () => {
          document.querySelectorAll('.violation-pill').forEach(p => p.classList.remove('is-active'));
          pill.classList.add('is-active');
          document.getElementById('violationType').value = pill.dataset.value;
        });
      });

      /* ─── GPS BUTTON ─── */
      const gpsBtn = document.getElementById('gpsBtn');
      const locationInput = document.getElementById('locationInput');
      if (gpsBtn && locationInput) {
        gpsBtn.addEventListener('click', () => {
          if (!navigator.geolocation) {
            SaralToast.show('Geolocation is not supported by your browser', 'error');
            return;
          }
          gpsBtn.classList.add('is-detecting');
          locationInput.value = 'Detecting location…';

          navigator.geolocation.getCurrentPosition(
            async pos => {
              const lat = pos.coords.latitude;
              const lon = pos.coords.longitude;
              try {
                // Nominatim reverse geocoding — free, no API key required
                const res = await fetch(
                  `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&addressdetails=1`,
                  { headers: { 'Accept-Language': 'en' } }
                );
                const data = await res.json();
                const a = data.address || {};

                // Build a readable string: "Suburb/Neighbourhood, City/Town, State"
                const parts = [
                  a.suburb || a.neighbourhood || a.village || a.hamlet || a.road,
                  a.city || a.town || a.county || a.district,
                  a.state,
                ].filter(Boolean);

                locationInput.value = parts.length > 0
                  ? parts.join(', ')
                  : data.display_name || `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
              } catch (_) {
                // Fallback to coordinates if reverse geocoding fails
                locationInput.value = `${lat.toFixed(4)}, ${lon.toFixed(4)}`;
              }
              gpsBtn.classList.remove('is-detecting');
            },
            err => {
              locationInput.value = '';
              SaralToast.show('Location access denied — please enter manually', 'error');
              gpsBtn.classList.remove('is-detecting');
            },
            { timeout: 10000, maximumAge: 60000 }
          );
        });
      }

      /* ─── FORM SUBMIT ─── */
      const form = document.getElementById('reportForm');
      if (form) {
        form.addEventListener('submit', async e => {
          e.preventDefault();

          // Ripple
          submitBtn.style.transform = 'scale(.97)';
          setTimeout(() => { submitBtn.style.transform = ''; }, 150);

          // If AI analysis already submitted the report, update all user-entered details and navigate
          if (aiResult && aiResult.report_id) {
            const plate = manualPlateInput ? manualPlateInput.value.trim().toUpperCase().replace(/[^A-Z0-9]/g, '') : '';
            const loc = document.getElementById('locationInput').value.trim();
            const desc = (document.querySelector('.studio-textarea')?.value || '').trim();
            const vType = document.getElementById('violationType').value || '';
            try {
              await SaralAPI.updateReportDetails(aiResult.report_id, {
                location: loc,
                description: desc,
                violationType: vType,
                manualPlate: plate,
              });
            } catch (err) {
              console.warn('[Report] Failed to update report details:', err);
            }
            window.location.href = 'my-reports.html';
            return;
          }

          // Fallback: if AI hasn't finished, manually submit
          if (!selectedFile) {
            SaralToast.show('Please upload evidence first', 'error');
            return;
          }

          submitBtn.disabled = true;
          submitBtn.classList.remove('is-ready');
          submitText.textContent = 'Submitting...';
          submitArrow.style.display = 'none';

          try {
            const userId = SaralAuth.getUserId();
            const violationType = document.getElementById('violationType').value || '';
            const location = document.getElementById('locationInput').value || '';
            const description = document.querySelector('.studio-textarea')?.value || '';
            const manualPlate = manualPlateInput ? manualPlateInput.value.trim() : '';

            const result = await SaralAPI.analyze(selectedFile, userId, violationType, location, description, manualPlate);
            SaralToast.show(`Report submitted! Plate: ${result.plate || 'N/A'}`, 'success');
            setTimeout(() => { window.location.href = 'my-reports.html'; }, 1200);
          } catch (err) {
            SaralToast.show('Submission failed: ' + err.message, 'error');
            submitBtn.disabled = false;
            submitBtn.classList.add('is-ready');
            submitText.textContent = 'Retry Submission';
            submitArrow.style.display = '';
          }
        });
      }

    })();
  </script>
</body>

</html>