<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard — SARAL</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@300;400;500;600;700&display=swap"
    rel="stylesheet" />
  <link rel="stylesheet" href="css/dashboard.css" />
  <!-- Leaflet.js for real maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body class="dash-body">

  <!-- ═══════ SIDEBAR ═══════ -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar__top">
      <a href="index.html" class="sidebar__logo">
        <svg width="28" height="28" viewBox="0 0 28 28" fill="none">
          <circle cx="14" cy="14" r="12" stroke="url(#sLogoG)" stroke-width="2.5" />
          <path d="M9 14.5L12.5 18L19 11" stroke="url(#sLogoG)" stroke-width="2.5" stroke-linecap="round"
            stroke-linejoin="round" />
          <defs>
            <linearGradient id="sLogoG" x1="0" y1="0" x2="28" y2="28">
              <stop stop-color="#4F8CFF" />
              <stop offset="1" stop-color="#A78BFA" />
            </linearGradient>
          </defs>
        </svg>
        <span>SARAL</span>
      </a>
    </div>

    <nav class="sidebar__nav">
      <a href="dashboard.html" class="sidebar__link sidebar__link--active">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
          <rect x="2" y="2" width="7" height="7" rx="2" stroke="currentColor" stroke-width="1.5" />
          <rect x="11" y="2" width="7" height="7" rx="2" stroke="currentColor" stroke-width="1.5" />
          <rect x="2" y="11" width="7" height="7" rx="2" stroke="currentColor" stroke-width="1.5" />
          <rect x="11" y="11" width="7" height="7" rx="2" stroke="currentColor" stroke-width="1.5" />
        </svg>
        <span>Overview</span>
      </a>
      <a href="report.html" class="sidebar__link">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
          <path d="M17 10a7 7 0 11-14 0 7 7 0 0114 0z" stroke="currentColor" stroke-width="1.5" />
          <path d="M10 7v3l2 1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
        </svg>
        <span>New Report</span>
      </a>
      <a href="my-reports.html" class="sidebar__link">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
          <path d="M4 6h12M4 10h12M4 14h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
        </svg>
        <span>My Reports</span>
      </a>
      <a href="rewards.html" class="sidebar__link">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
          <path d="M10 2l2.09 4.26L17 6.97l-3.5 3.42.83 4.84L10 13.14l-4.33 2.09.83-4.84L3 6.97l4.91-.71L10 2z"
            stroke="currentColor" stroke-width="1.5" stroke-linejoin="round" />
        </svg>
        <span>Rewards</span>
      </a>
      <a href="settings.html" class="sidebar__link">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
          <circle cx="10" cy="10" r="3" stroke="currentColor" stroke-width="1.5" />
          <path
            d="M10 2v2M10 16v2M2 10h2M16 10h2M4.93 4.93l1.41 1.41M13.66 13.66l1.41 1.41M15.07 4.93l-1.41 1.41M6.34 13.66l-1.41 1.41"
            stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
        </svg>
        <span>Settings</span>
      </a>
    </nav>

    <div class="sidebar__profile">
      <div class="sidebar__profile-avatar">
        <span>AK</span>
      </div>
      <div class="sidebar__profile-info">
        <span class="sidebar__profile-name">Aarav Kumar</span>
        <span class="sidebar__profile-badge">
          <svg width="10" height="10" viewBox="0 0 10 10" fill="none">
            <circle cx="5" cy="5" r="4" fill="#FFD700" />
          </svg>
          Gold Champion
        </span>
      </div>
    </div>
    <button class="sidebar__logout" onclick="SaralAuth.signOut()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
        <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9" stroke="currentColor" stroke-width="1.5"
          stroke-linecap="round" stroke-linejoin="round" />
      </svg>
      <span>Logout</span>
    </button>
  </aside>

  <!-- ═══════ MOBILE HEADER ═══════ -->
  <header class="dash-header" id="dashHeader">
    <button class="dash-header__toggle" id="sidebarToggle">
      <span></span><span></span><span></span>
    </button>
    <a href="index.html" class="dash-header__logo">SARAL</a>
    <a href="report.html" class="dash-header__action">
      <svg width="18" height="18" viewBox="0 0 18 18" fill="none">
        <path d="M9 3v12M3 9h12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
      </svg>
    </a>
  </header>

  <!-- ═══════ MAIN CONTENT ═══════ -->
  <main class="dash-main">
    <!-- Greeting -->
    <div class="dash-greeting" data-reveal>
      <div>
        <h1 class="dash-greeting__title">Welcome back, <span class="text-gradient">Aarav</span></h1>
        <p class="dash-greeting__sub">Your contribution makes roads safer. Keep reporting.</p>
      </div>
      <a href="report.html" class="btn btn--primary btn--glow">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
          <path d="M8 2v12M2 8h12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
        </svg>
        <span>New Report</span>
      </a>
    </div>

    <!-- Stats Row -->
    <div class="dash-stats" data-reveal>
      <div class="dash-stat dash-stat--blue">
        <div class="dash-stat__icon">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path d="M4 16V8M8 16V4M12 16v-5M16 16V9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
          </svg>
        </div>
        <div class="dash-stat__info">
          <span class="dash-stat__num" data-count="47">0</span>
          <span class="dash-stat__label">Total Reports</span>
        </div>
        <span class="dash-stat__trend dash-stat__trend--up">+12%</span>
      </div>
      <div class="dash-stat dash-stat--green">
        <div class="dash-stat__icon">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path d="M18 10A8 8 0 112 10a8 8 0 0116 0z" stroke="currentColor" stroke-width="1.5" />
            <path d="M7 10l2 2 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
              stroke-linejoin="round" />
          </svg>
        </div>
        <div class="dash-stat__info">
          <span class="dash-stat__num" data-count="42">0</span>
          <span class="dash-stat__label">Verified</span>
        </div>
        <span class="dash-stat__trend dash-stat__trend--up">89%</span>
      </div>
      <div class="dash-stat dash-stat--amber">
        <div class="dash-stat__icon">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path d="M10 2l2.09 4.26L17 6.97l-3.5 3.42.83 4.84L10 13.14l-4.33 2.09.83-4.84L3 6.97l4.91-.71L10 2z"
              stroke="currentColor" stroke-width="1.5" stroke-linejoin="round" />
          </svg>
        </div>
        <div class="dash-stat__info">
          <span class="dash-stat__num" data-count="1250">0</span>
          <span class="dash-stat__label">Karma Points</span>
        </div>
        <span class="dash-stat__badge">Gold</span>
      </div>
      <div class="dash-stat dash-stat--violet">
        <div class="dash-stat__icon">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path d="M3 17V5a2 2 0 012-2h10a2 2 0 012 2v12l-3.5-2L10 17l-3.5-2L3 17z" stroke="currentColor"
              stroke-width="1.5" />
          </svg>
        </div>
        <div class="dash-stat__info">
          <span class="dash-stat__num" data-count="3">0</span>
          <span class="dash-stat__label">Pending</span>
        </div>
      </div>
    </div>

    <!-- Main Grid -->
    <div class="dash-grid">
      <!-- Activity Chart -->
      <div class="dash-card dash-card--wide" data-reveal>
        <div class="dash-card__header">
          <h3>Reporting Activity</h3>
          <div class="dash-card__tabs">
            <button class="dash-card__tab dash-card__tab--active">Week</button>
            <button class="dash-card__tab">Month</button>
            <button class="dash-card__tab">Year</button>
          </div>
        </div>
        <div class="dash-chart">
          <div class="dash-chart__bars">
            <div class="dash-chart__bar-group">
              <div class="dash-chart__bar" style="--h: 40%"><span>Mon</span></div>
            </div>
            <div class="dash-chart__bar-group">
              <div class="dash-chart__bar" style="--h: 65%"><span>Tue</span></div>
            </div>
            <div class="dash-chart__bar-group">
              <div class="dash-chart__bar" style="--h: 35%"><span>Wed</span></div>
            </div>
            <div class="dash-chart__bar-group">
              <div class="dash-chart__bar dash-chart__bar--accent" style="--h: 85%"><span>Thu</span></div>
            </div>
            <div class="dash-chart__bar-group">
              <div class="dash-chart__bar" style="--h: 55%"><span>Fri</span></div>
            </div>
            <div class="dash-chart__bar-group">
              <div class="dash-chart__bar" style="--h: 70%"><span>Sat</span></div>
            </div>
            <div class="dash-chart__bar-group">
              <div class="dash-chart__bar" style="--h: 25%"><span>Sun</span></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Reports -->
      <div class="dash-card" data-reveal>
        <div class="dash-card__header">
          <h3>Recent Reports</h3>
          <a href="#" class="dash-card__link">View all</a>
        </div>
        <div class="dash-reports">
          <div class="dash-report">
            <div class="dash-report__icon dash-report__icon--red">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M8 3v5M8 11h.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
              </svg>
            </div>
            <div class="dash-report__info">
              <span class="dash-report__title">Signal Violation — MG Road</span>
              <span class="dash-report__time">2 hours ago</span>
            </div>
            <span class="dash-report__status dash-report__status--verified">Verified</span>
          </div>
          <div class="dash-report">
            <div class="dash-report__icon dash-report__icon--amber">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M8 3v5M8 11h.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
              </svg>
            </div>
            <div class="dash-report__info">
              <span class="dash-report__title">Wrong-Way Driving — NH48</span>
              <span class="dash-report__time">5 hours ago</span>
            </div>
            <span class="dash-report__status dash-report__status--pending">Pending</span>
          </div>
          <div class="dash-report">
            <div class="dash-report__icon dash-report__icon--green">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M5 8l2 2 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                  stroke-linejoin="round" />
              </svg>
            </div>
            <div class="dash-report__info">
              <span class="dash-report__title">Parking Violation — Sector 17</span>
              <span class="dash-report__time">Yesterday</span>
            </div>
            <span class="dash-report__status dash-report__status--resolved">Resolved</span>
          </div>
          <div class="dash-report">
            <div class="dash-report__icon dash-report__icon--green">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M5 8l2 2 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                  stroke-linejoin="round" />
              </svg>
            </div>
            <div class="dash-report__info">
              <span class="dash-report__title">Over Speeding — Ring Road</span>
              <span class="dash-report__time">2 days ago</span>
            </div>
            <span class="dash-report__status dash-report__status--resolved">Resolved</span>
          </div>
        </div>
      </div>

      <!-- Karma Progress -->
      <div class="dash-card dash-card--karma" data-reveal>
        <div class="dash-card__header">
          <h3>Karma Progress</h3>
        </div>
        <div class="dash-karma">
          <div class="dash-karma__circle">
            <svg viewBox="0 0 120 120">
              <circle cx="60" cy="60" r="52" fill="none" stroke="var(--gray-100)" stroke-width="8" />
              <circle cx="60" cy="60" r="52" fill="none" stroke="url(#karmaGrad)" stroke-width="8"
                stroke-linecap="round" stroke-dasharray="326.73" stroke-dashoffset="82" transform="rotate(-90 60 60)" />
              <defs>
                <linearGradient id="karmaGrad" x1="0" y1="0" x2="120" y2="120">
                  <stop stop-color="#4F8CFF" />
                  <stop offset="1" stop-color="#A78BFA" />
                </linearGradient>
              </defs>
            </svg>
            <div class="dash-karma__value">
              <span class="dash-karma__num">1,250</span>
              <span class="dash-karma__of">/ 1,500</span>
            </div>
          </div>
          <div class="dash-karma__tiers">
            <div class="dash-karma__tier dash-karma__tier--done">Bronze</div>
            <div class="dash-karma__tier dash-karma__tier--done">Silver</div>
            <div class="dash-karma__tier dash-karma__tier--current">Gold</div>
            <div class="dash-karma__tier">Platinum</div>
          </div>
        </div>
      </div>

      <!-- Violation Hotspot Map -->
      <div class="dash-card dash-card--wide" data-reveal>
        <div class="dash-card__header">
          <h3>Violation Hotspot Map</h3>
          <span class="dash-card__sub">Top locations by reported violations</span>
        </div>
        <div class="violation-map">
          <div class="violation-map__leaflet" id="leafletMap"></div>
          <div class="violation-map__legend">
            <span class="violation-map__legend-label">Low</span>
            <div class="violation-map__legend-bar"></div>
            <span class="violation-map__legend-label">High</span>
          </div>
        </div>
        <div class="violation-map__list" id="violationList"></div>
      </div>
    </div>
  </main>

  <script src="js/api.js"></script>
  <script src="js/store.js"></script>
  <script src="js/auth.js"></script>
  <script>SaralAuth.requireAuth('user');</script>
  <script src="js/dashboard.js"></script>
  <script>
    // Load real data from API
    (async function () {
      const userId = SaralAuth.getUserId();
      if (!userId) return;

      try {
        // Refresh user data from API
        await SaralAuth.refreshUser();
        const user = SaralAuth.getUser();
        const state = SaralStore.get();

        // Update greeting
        const greetTitle = document.querySelector('.dash-greeting__title');
        if (greetTitle) {
          const firstName = user.name.split(' ')[0];
          greetTitle.innerHTML = `Welcome back, <span class="text-gradient">${firstName}</span>`;
        }

        // Update sidebar profile
        const profileName = document.querySelector('.sidebar__profile-name');
        const profileAvatar = document.querySelector('.sidebar__profile-avatar span');
        const profileBadge = document.querySelector('.sidebar__profile-badge');
        if (profileName) profileName.textContent = user.name;
        if (profileAvatar) profileAvatar.textContent = state.user.initials;
        // Tier is computed from LIVE karma below — placeholder for now
        if (profileBadge) profileBadge.dataset.updateTier = '1';

        // Fetch stats from API
        const stats = await SaralAPI.getUserStats(userId);

        // Update stat cards
        const statNums = document.querySelectorAll('.dash-stat__num');
        if (statNums[0]) statNums[0].dataset.count = stats.total;
        if (statNums[1]) statNums[1].dataset.count = stats.approved;
        if (statNums[2]) statNums[2].dataset.count = stats.karma_points;
        if (statNums[3]) statNums[3].dataset.count = stats.pending;

        // Update trend for verified
        const verifiedTrend = document.querySelectorAll('.dash-stat__trend');
        if (verifiedTrend[1] && stats.total > 0) {
          verifiedTrend[1].textContent = Math.round(stats.approved / stats.total * 100) + '%';
        }

        // ── Compute tier from LIVE karma ────────────────────────────────
        const { current: currentTier, next: nextTier, TIERS: tiers } = SaralStore.getTierInfo(stats.karma_points);

        // Update sidebar badge with correct live tier
        if (profileBadge) {
          profileBadge.innerHTML = `<svg width="10" height="10" viewBox="0 0 10 10" fill="none"><circle cx="5" cy="5" r="4" fill="${currentTier.color}"/></svg> ${currentTier.icon} ${currentTier.name} Champion`;
        }

        // Update stat card tier badge
        const tierBadge = document.querySelector('.dash-stat__badge');
        if (tierBadge) tierBadge.textContent = currentTier.name;

        // Update karma circle number
        const karmaNum = document.querySelector('.dash-karma__num');
        if (karmaNum) karmaNum.textContent = stats.karma_points.toLocaleString();

        // Update karma circle next-tier label
        const karmaOf = document.querySelector('.dash-karma__of');
        if (karmaOf) karmaOf.textContent = nextTier ? `/ ${nextTier.min.toLocaleString()}` : '/ MAX';

        // Karma circle progress arc
        const karmaCircle = document.querySelector('.dash-karma__circle circle:nth-child(2)');
        if (karmaCircle && nextTier) {
          const progress = (stats.karma_points - currentTier.min) / (nextTier.min - currentTier.min);
          const circumference = 326.73;
          karmaCircle.setAttribute('stroke-dashoffset', circumference * (1 - Math.min(progress, 1)));
        }

        // Update tier markers
        const tierEls = document.querySelectorAll('.dash-karma__tier');
        tierEls.forEach(el => {
          const tierName = el.textContent.trim();
          const tierIdx = tiers.findIndex(t => t.name === tierName);
          const curIdx = tiers.findIndex(t => t.name === currentTier.name);
          el.classList.remove('dash-karma__tier--done', 'dash-karma__tier--current');
          if (tierIdx < curIdx) el.classList.add('dash-karma__tier--done');
          if (tierIdx === curIdx) el.classList.add('dash-karma__tier--current');
        });

        // Fetch and render recent reports
        const reportsData = await SaralAPI.getUserReports(userId);
        const reportsContainer = document.querySelector('.dash-reports');
        if (reportsContainer && reportsData.reports) {
          reportsContainer.innerHTML = '';
          const recent = reportsData.reports.slice(0, 5);
          if (recent.length === 0) {
            reportsContainer.innerHTML = '<div style="text-align:center;padding:24px;color:#94a3b8;font-size:13px;">No reports yet. Submit your first report!</div>';
          }
          recent.forEach(r => {
            const statusMap = { 'Under Review': 'pending', 'Approved': 'verified', 'Rejected': 'rejected' };
            const statusCls = statusMap[r.status] || 'pending';
            const statusLabel = r.status;
            const iconColor = r.status === 'Approved' ? 'green' : r.status === 'Rejected' ? 'red' : 'amber';
            const icon = r.status === 'Approved'
              ? '<path d="M5 8l2 2 4-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>'
              : '<path d="M8 3v5M8 11h.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>';

            const date = new Date(r.created_at);
            const now = new Date();
            const diffH = Math.floor((now - date) / 3600000);
            let timeStr;
            if (diffH < 1) timeStr = 'Just now';
            else if (diffH < 24) timeStr = diffH + 'h ago';
            else if (diffH < 48) timeStr = 'Yesterday';
            else timeStr = Math.floor(diffH / 24) + ' days ago';

            const plateStr = r.plate_number ? ` — ${r.plate_number}` : '';

            const el = document.createElement('div');
            el.className = 'dash-report';
            el.innerHTML = `
              <div class="dash-report__icon dash-report__icon--${iconColor}">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">${icon}</svg>
              </div>
              <div class="dash-report__info">
                <span class="dash-report__title">${r.violation_type}${plateStr}</span>
                <span class="dash-report__time">${timeStr}</span>
              </div>
              <span class="dash-report__status dash-report__status--${statusCls}">${statusLabel}</span>
            `;
            reportsContainer.appendChild(el);
          });
        }

        // Re-trigger counter animations
        document.querySelectorAll('[data-count]').forEach(el => {
          const target = parseInt(el.dataset.count, 10);
          const duration = 1500;
          const start = performance.now();
          const easeOut = t => 1 - Math.pow(1 - t, 3);
          const tick = (now) => {
            const elapsed = now - start;
            const progress = Math.min(elapsed / duration, 1);
            el.textContent = Math.round(target * easeOut(progress)).toLocaleString();
            if (progress < 1) requestAnimationFrame(tick);
          };
          requestAnimationFrame(tick);
        });

        // Update View all link
        const viewAllLink = document.querySelector('.dash-card__link');
        if (viewAllLink) viewAllLink.href = 'my-reports.html';

      } catch (err) {
        console.error('[Dashboard] Failed to load data:', err);
        SaralToast.show('Failed to load dashboard data: ' + err.message, 'error');
      }
    })();
  </script>
</body>

</html>