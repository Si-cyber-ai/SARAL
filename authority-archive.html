<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reports Archive â€” Authority Dashboard â€” SARAL</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="css/dashboard.css" />
  <link rel="stylesheet" href="css/authority.css" />
</head>
<body class="dash-body">

  <!-- â•â•â•â•â•â•â• SIDEBAR â•â•â•â•â•â•â• -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar__top">
      <a href="index.html" class="sidebar__logo">
        <svg width="28" height="28" viewBox="0 0 28 28" fill="none">
          <circle cx="14" cy="14" r="12" stroke="url(#sLogoG2)" stroke-width="2.5"/>
          <path d="M9 14.5L12.5 18L19 11" stroke="url(#sLogoG2)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
          <defs><linearGradient id="sLogoG2" x1="0" y1="0" x2="28" y2="28"><stop stop-color="#4F8CFF"/><stop offset="1" stop-color="#A78BFA"/></linearGradient></defs>
        </svg>
        <span>SARAL</span>
        <span class="auth-badge">Authority</span>
      </a>
    </div>

    <nav class="sidebar__nav">
      <a href="authority.html" class="sidebar__link">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><rect x="2" y="2" width="7" height="7" rx="2" stroke="currentColor" stroke-width="1.5"/><rect x="11" y="2" width="7" height="7" rx="2" stroke="currentColor" stroke-width="1.5"/><rect x="2" y="11" width="7" height="7" rx="2" stroke="currentColor" stroke-width="1.5"/><rect x="11" y="11" width="7" height="7" rx="2" stroke="currentColor" stroke-width="1.5"/></svg>
        <span>Case Queue</span>
      </a>
      <a href="authority-analytics.html" class="sidebar__link">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M4 16V8M8 16V4M12 16v-5M16 16V9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        <span>Analytics</span>
      </a>
      <a href="authority-archive.html" class="sidebar__link sidebar__link--active">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M12 2H4a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z" stroke="currentColor" stroke-width="1.5"/><path d="M12 2v6h6" stroke="currentColor" stroke-width="1.5"/></svg>
        <span>Reports Archive</span>
      </a>
      <a href="authority-settings.html" class="sidebar__link">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><circle cx="10" cy="10" r="3" stroke="currentColor" stroke-width="1.5"/><path d="M10 2v2M10 16v2M2 10h2M16 10h2M4.93 4.93l1.41 1.41M13.66 13.66l1.41 1.41M15.07 4.93l-1.41 1.41M6.34 13.66l-1.41 1.41" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        <span>Settings</span>
      </a>
    </nav>

    <div class="sidebar__profile">
      <div class="sidebar__profile-avatar" style="background: linear-gradient(135deg, #8B5CF6, #4F8CFF);">
        <span>TP</span>
      </div>
      <div class="sidebar__profile-info">
        <span class="sidebar__profile-name">Insp. T. Prasad</span>
        <span class="sidebar__profile-badge" style="color: var(--violet-500);">
          <svg width="10" height="10" viewBox="0 0 10 10" fill="none"><path d="M5 1l1.2 2.4L9 3.8 7 5.7l.5 2.8L5 7.3 2.5 8.5 3 5.7 1 3.8l2.8-.4L5 1z" fill="#8B5CF6"/></svg>
          Traffic Inspector
        </span>
      </div>
    </div>
    <button class="sidebar__logout" onclick="SaralAuth.signOut()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4M16 17l5-5-5-5M21 12H9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <span>Logout</span>
    </button>
  </aside>

  <!-- MOBILE HEADER -->
  <header class="dash-header" id="dashHeader">
    <button class="dash-header__toggle" id="sidebarToggle">
      <span></span><span></span><span></span>
    </button>
    <a href="index.html" class="dash-header__logo">SARAL Authority</a>
    <span></span>
  </header>

  <!-- MAIN -->
  <main class="dash-main">
    <div class="dash-greeting" data-reveal>
      <div>
        <h1 class="dash-greeting__title">Reports Archive</h1>
        <p class="dash-greeting__sub">Historical records of reviewed cases</p>
      </div>
    </div>

    <!-- Filters -->
    <div class="filter-bar" data-reveal>
      <div class="filter-bar__search-wrap">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><circle cx="7" cy="7" r="5" stroke="currentColor" stroke-width="1.5"/><path d="M11 11l3 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        <input type="text" class="filter-bar__search" id="searchPlate" placeholder="Search by plate number, case ID, or location..." />
      </div>
      <select class="filter-bar__select" id="filterDecision">
        <option value="all">All Decisions</option>
        <option value="approved">Approved</option>
        <option value="rejected">Rejected</option>
      </select>
      <select class="filter-bar__select" id="filterSort">
        <option value="newest">Newest First</option>
        <option value="oldest">Oldest First</option>
        <option value="confidence-high">Confidence: High â†’ Low</option>
        <option value="confidence-low">Confidence: Low â†’ High</option>
      </select>
    </div>

    <!-- Table -->
    <div class="archive-table-wrap" data-reveal>
      <table class="archive-table" id="archiveTable">
        <thead>
          <tr>
            <th>Case ID</th>
            <th>Violation Type</th>
            <th>Location</th>
            <th>AI Confidence</th>
            <th>Decision</th>
            <th>Reviewed By</th>
            <th>Date</th>
          </tr>
        </thead>
        <tbody id="archiveBody">
          <!-- JS populated -->
        </tbody>
      </table>
    </div>

    <!-- Result count -->
    <div style="margin-top: 16px; font-size: 13px; color: var(--gray-400);" id="resultCount" data-reveal></div>
  </main>

  <!-- Detail Drawer -->
  <div class="detail-drawer-overlay" id="drawerOverlay"></div>
  <div class="detail-drawer" id="detailDrawer">
    <div class="detail-drawer__header">
      <span class="detail-drawer__title" id="drawerTitle">Case Details</span>
      <button class="detail-drawer__close" id="drawerClose">
        <svg width="18" height="18" viewBox="0 0 18 18" fill="none"><path d="M5 5l8 8M13 5l-8 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
      </button>
    </div>
    <div class="detail-drawer__body" id="drawerBody">
      <!-- JS populated -->
    </div>
  </div>

  <script src="js/api.js"></script>
  <script src="js/store.js"></script>
  <script src="js/auth.js"></script>
  <script>SaralAuth.requireAuth('authority');</script>
  <script src="js/dashboard.js"></script>
  <script>
    (function () {
      'use strict';

      /* â”€â”€â”€ ARCHIVE DATA â€” loaded from API â”€â”€â”€ */
      let archiveData = [];

      const tbody = document.getElementById('archiveBody');
      const resultCount = document.getElementById('resultCount');
      const searchInput = document.getElementById('searchPlate');
      const decisionFilter = document.getElementById('filterDecision');
      const sortFilter = document.getElementById('filterSort');

      async function loadArchive() {
        try {
          const res = await SaralAPI.getAllReports();
          const reports = res.reports || [];
          // Only show authority-reviewed reports (Approved or Rejected by authority, NOT Auto-Rejected)
          archiveData = reports
            .filter(r => r.status === 'Approved' || r.status === 'Rejected')
            .map((r, i) => {
              const dt = new Date(r.created_at);
              return {
                id: 'SARAL-' + String(r.id).padStart(6, '0'),
                rawId: r.id,
                type: r.violation_type || 'Unknown',
                plate: r.plate_number || 'â€”',
                manualPlate: r.manual_plate || '',
                location: r.location || 'Unknown',
                confidence: r.confidence ? Math.round(r.confidence) : 0,
                decision: r.status === 'Approved' ? 'approved' : 'rejected',
                reviewer: r.reviewer || 'Authority',
                date: dt.toISOString().split('T')[0],
                time: dt.toTimeString().slice(0, 5),
                mediaUrl: r.media_url || null,
                annotatedUrl: r.annotated_url || null,
                helmet: r.helmet_detected,
              };
            });

          renderTable(archiveData);
        } catch (err) {
          console.error('[Archive] Failed to load:', err);
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:32px;color:#94a3b8;">Failed to load archive data</td></tr>';
          resultCount.textContent = '0 records';
        }
      }

      function renderTable(data) {
        tbody.innerHTML = '';
        if (data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:32px;color:#94a3b8;">No reviewed reports yet</td></tr>';
          resultCount.textContent = '0 records';
          return;
        }
        data.forEach(row => {
          const tr = document.createElement('tr');
          tr.dataset.caseId = row.id;
          tr.innerHTML = `
            <td style="font-weight: 600; color: var(--gray-800); font-size: 12px; font-family: var(--font-display);">${row.id}</td>
            <td>
              ${row.type}
              <div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:3px;">
                <span style="display:inline-flex;align-items:center;gap:2px;background:rgba(79,140,255,.1);color:#1e40af;font-size:9px;font-weight:700;padding:1px 5px;border-radius:4px;font-family:var(--font-display);letter-spacing:.3px;border:1px solid rgba(79,140,255,.15);" title="AI detected plate">ðŸ¤– ${row.plate}</span>
                ${row.manualPlate ? `<span style="display:inline-flex;align-items:center;gap:2px;background:rgba(251,191,36,.12);color:#78350f;font-size:9px;font-weight:700;padding:1px 5px;border-radius:4px;font-family:var(--font-display);letter-spacing:.3px;border:1px solid rgba(251,191,36,.2);" title="Citizen reported plate">ðŸš— ${row.manualPlate}</span>` : ''}
              </div>
            </td>
            <td>${row.location}</td>
            <td>
              <span class="confidence-bar"><span class="confidence-bar__fill" style="width: ${row.confidence}%; background: ${row.confidence >= 90 ? 'var(--green-500)' : row.confidence >= 80 ? 'var(--blue-500)' : 'var(--amber-500)'}"></span></span>
              ${row.confidence}%
            </td>
            <td><span class="decision-badge decision-badge--${row.decision}">${row.decision === 'approved' ? 'âœ“ Approved' : 'âœ• Rejected'}</span></td>
            <td>${row.reviewer}</td>
            <td style="color: var(--gray-400);">${row.date}</td>
          `;
          tr.addEventListener('click', function () { openDrawer(row); });
          tbody.appendChild(tr);
        });
        resultCount.textContent = data.length + ' of ' + archiveData.length + ' records';
      }

      function getFilteredData() {
        let data = [...archiveData];

        // Search
        const q = searchInput.value.trim().toLowerCase();
        if (q) {
          data = data.filter(r =>
            r.id.toLowerCase().includes(q) ||
            r.plate.toLowerCase().includes(q) ||
            r.manualPlate.toLowerCase().includes(q) ||
            r.location.toLowerCase().includes(q) ||
            r.type.toLowerCase().includes(q)
          );
        }

        // Decision filter
        const dec = decisionFilter.value;
        if (dec !== 'all') data = data.filter(r => r.decision === dec);

        // Sort
        const sort = sortFilter.value;
        if (sort === 'newest') data.sort((a, b) => b.date.localeCompare(a.date) || b.time.localeCompare(a.time));
        else if (sort === 'oldest') data.sort((a, b) => a.date.localeCompare(b.date) || a.time.localeCompare(b.time));
        else if (sort === 'confidence-high') data.sort((a, b) => b.confidence - a.confidence);
        else if (sort === 'confidence-low') data.sort((a, b) => a.confidence - b.confidence);

        return data;
      }

      function applyFilters() { renderTable(getFilteredData()); }

      searchInput.addEventListener('input', applyFilters);
      decisionFilter.addEventListener('change', applyFilters);
      sortFilter.addEventListener('change', applyFilters);

      // Load archive from API
      loadArchive();

      /* â”€â”€â”€ DETAIL DRAWER â”€â”€â”€ */
      const overlay = document.getElementById('drawerOverlay');
      const drawer  = document.getElementById('detailDrawer');
      const drawerTitle = document.getElementById('drawerTitle');
      const drawerBody  = document.getElementById('drawerBody');
      const drawerClose = document.getElementById('drawerClose');

      function openDrawer(row) {
        drawerTitle.textContent = row.id;

        // AI-annotated image section (with bounding boxes)
        let imageSection = '';
        if (row.annotatedUrl) {
          imageSection += `
            <div style="margin-bottom:16px;">
              <div style="font-size:12px;font-weight:600;color:var(--gray-500);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px;">AI Detection Result</div>
              <img src="${SaralAPI.mediaUrl(row.annotatedUrl)}" style="width:100%;border-radius:12px;border:1px solid rgba(0,0,0,.08);cursor:pointer;" alt="AI Annotated" onclick="window.open(this.src,'_blank')" title="Click to view full size" />
              <div style="font-size:11px;color:var(--gray-400);margin-top:4px;text-align:center;">Bounding boxes show detected plates &amp; helmets</div>
            </div>
          `;
        }
        if (row.mediaUrl) {
          imageSection += `
            <div style="margin-bottom:16px;">
              <div style="font-size:12px;font-weight:600;color:var(--gray-500);margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px;">Original Evidence</div>
              <img src="${SaralAPI.mediaUrl(row.mediaUrl)}" style="width:100%;border-radius:12px;border:1px solid rgba(0,0,0,.08);cursor:pointer;" alt="Original Evidence" onclick="window.open(this.src,'_blank')" title="Click to view full size" />
            </div>
          `;
        }

        drawerBody.innerHTML = `
          ${imageSection}
          <div class="detail-drawer__row"><span class="detail-drawer__label">Case ID</span><span class="detail-drawer__value">${row.id}</span></div>
          <div class="detail-drawer__row"><span class="detail-drawer__label">Violation Type</span><span class="detail-drawer__value">${row.type}</span></div>
          <div style="background:rgba(79,140,255,.06);border-radius:12px;padding:12px 14px;margin:4px -4px;border:1px solid rgba(79,140,255,.15);">
            <div style="font-size:10px;font-weight:700;color:#3b82f6;text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px;">ðŸ¤– AI Detected Plate (OCR)</div>
            <div style="font-family:var(--font-display);font-weight:800;font-size:18px;color:#1e3a5f;letter-spacing:2px;">${row.plate || 'Not detected'}</div>
          </div>
          <div style="background:linear-gradient(135deg,rgba(251,191,36,.08),rgba(245,158,11,.05));border-radius:12px;padding:12px 14px;margin:4px -4px;border:1px solid rgba(251,191,36,.2);">
            <div style="font-size:10px;font-weight:700;color:#b45309;text-transform:uppercase;letter-spacing:.8px;margin-bottom:6px;">ðŸš— Citizen Reported Plate</div>
            <div style="font-family:var(--font-display);font-weight:800;font-size:18px;color:#92400e;letter-spacing:2px;">${row.manualPlate || 'Not provided'}</div>
          </div>
          ${(row.plate && row.plate !== 'â€”' && row.manualPlate) ? `
          <div style="text-align:center;padding:4px 0;">
            ${row.plate.replace(/[^A-Z0-9]/gi,'').toUpperCase() === row.manualPlate.replace(/[^A-Z0-9]/gi,'').toUpperCase()
              ? '<span style="background:rgba(16,185,129,.1);color:#065f46;font-size:11px;font-weight:700;padding:3px 10px;border-radius:6px;border:1px solid rgba(16,185,129,.2);">âœ“ Plates Match</span>'
              : '<span style="background:rgba(239,68,68,.08);color:#991b1b;font-size:11px;font-weight:700;padding:3px 10px;border-radius:6px;border:1px solid rgba(239,68,68,.15);">âš  Plates Differ â€” Verify Manually</span>'
            }
          </div>
          ` : ''}
          <div class="detail-drawer__row"><span class="detail-drawer__label">Location</span><span class="detail-drawer__value">${row.location}</span></div>
          <div class="detail-drawer__row"><span class="detail-drawer__label">AI Confidence</span><span class="detail-drawer__value">${row.confidence}%</span></div>
          <div class="detail-drawer__row"><span class="detail-drawer__label">Decision</span><span class="detail-drawer__value"><span class="decision-badge decision-badge--${row.decision}">${row.decision === 'approved' ? 'âœ“ Approved' : 'âœ• Rejected'}</span></span></div>
          <div class="detail-drawer__row"><span class="detail-drawer__label">Reviewed By</span><span class="detail-drawer__value">${row.reviewer}</span></div>
          <div class="detail-drawer__row"><span class="detail-drawer__label">Date &amp; Time</span><span class="detail-drawer__value">${row.date} at ${row.time}</span></div>
          ${row.helmet ? `<div class="detail-drawer__row"><span class="detail-drawer__label">Helmet Detection</span><span class="detail-drawer__value">${row.helmet}</span></div>` : ''}
        `;
        overlay.classList.add('detail-drawer-overlay--open');
        drawer.classList.add('detail-drawer--open');
      }

      function closeDrawer() {
        overlay.classList.remove('detail-drawer-overlay--open');
        drawer.classList.remove('detail-drawer--open');
      }

      drawerClose.addEventListener('click', closeDrawer);
      overlay.addEventListener('click', closeDrawer);
      document.addEventListener('keydown', function (e) { if (e.key === 'Escape') closeDrawer(); });
    })();
  </script>
</body>
</html>
